<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vivora Fashion Illustration 2025</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="app-container">

    <!-- メインワークスペース -->
    <main class="main-workspace">
      <!-- ヘッダー -->
      <header class="main-header">
        <h1 class="title">Vivora Fashion Illustration 2025</h1>
        <div class="gender-selector">
          <button class="gender-button active" data-gender="woman">Woman</button>
          <button class="gender-button" data-gender="man">Man</button>
          <button class="gender-button" data-gender="kids">Kids</button>
        </div>
      </header>

      <!-- ツールバー -->
      <div class="toolbar-area">
        <!-- アクションツール -->
        <div class="action-toolbar">
          <button class="icon-button" id="btn-undo"><img src="../../create_parts/create_button/retreat.png" alt="Undo"></button>
          <button class="icon-button" id="btn-redo"><img src="../../create_parts/create_button/forward.png" alt="Redo"></button>
          <button class="icon-button" id="btn-reset"><img src="../../create_parts/create_button/reset.png" alt="Reset"></button>
          <button class="icon-button" id="btn-download"><img src="../../create_parts/create_button/download.png" alt="Download"></button>
          <button class="icon-button" id="btn-upload"><img src="../../create_parts/create_button/upload.png" alt="Upload"></button>
          <button class="icon-button" id="btn-save"><img src="../../create_parts/create_button/save.png" alt="Save"></button>
          <button class="icon-button" id="grid-toggle"><img src="../../create_parts/create_button/graph_paper.png" alt="Grid"></button>
        </div>

        <!-- コンテンツツール -->
        <div class="content-toolbar">
          <button class="icon-button"><img src="../../create_parts/contents_button/1_fashion-illustrations.png" alt="Fashion Illustration"></button>
          <button class="icon-button"><img src="../../create_parts/contents_button/2_fabric-matching.png" alt="Fabric Matching"></button>
          <button class="icon-button"><img src="../../create_parts/contents_button/3_clothing-design.png" alt="Clothing Design"></button>
          <button class="icon-button"><img src="../../create_parts/contents_button/4_pattern-creation.png" alt="Pattern Creation"></button>
          <button class="icon-button"><img src="../../create_parts/contents_button/5_grading.png" alt="Grading"></button>
          <button class="icon-button"><img src="../../create_parts/contents_button/6_print-layout-cut.png" alt="Print Layout"></button>
          <button class="icon-button"><img src="../../create_parts/contents_button/digital-dressing-kids-mode.png" alt="Digital Kids Dressing"></button>
        </div>
      </div>

      <!-- キャンバス -->
      <div id="canvas-wrapper" class="canvas-wrapper">
        <img id="mannequin" class="mannequin-base" src="../../mannequin/mannequin_woman.png" alt="Mannequin">
      </div>
    </main>

    <!-- サイドバー -->
    <aside class="sidebar-controls">
      <!-- Next Step -->
      <div class="next-step-panel">
        <button class="next-step-button">Next Step ▶▶</button>
      </div>

      <!-- ポーズ選択 -->
      <div id="pose-selector" class="panel pose-selector">
        <button class="arrow left-arrow">‹</button>
        <div class="pose-thumbnails">
          <img class="pose-thumb selected" src="../../mannequin/pose1.png" data-pose-src="../../mannequin/mannequin_woman.png">
          <img class="pose-thumb" src="../../mannequin/pose2.png" data-pose-src="../../mannequin/mannequin_woman_pose2.png">
          <img class="pose-thumb" src="../../mannequin/pose3.png" data-pose-src="../../mannequin/mannequin_woman_pose3.png">
          <img class="pose-thumb" src="../../mannequin/pose4.png" data-pose-src="../../mannequin/mannequin_woman_pose4.png">
        </div>
        <button class="arrow right-arrow">›</button>
      </div>

      <!-- ステーショナリーツール -->
      <div id="stationery-panel" class="panel stationery-panel">
        <h2 class="panel-title">Stationery</h2>
        <div id="stationery-grid" class="stationery-grid">
          <div class="tool-button" data-tool="select"><img src="../../create_parts/design_button/select.png" alt="Select"></div>
          <div class="tool-button" data-tool="direct_select"><img src="../../create_parts/design_button/direct_select.png" alt="Direct Select"></div>
          <div class="tool-button" data-tool="text"><img src="../../create_parts/design_button/sentence.png" alt="Text"></div>
          <div class="tool-button" data-tool="fill"><img src="../../create_parts/design_button/fill.png" alt="Fill"></div>
          <div class="tool-button" data-tool="pen"><img src="../../create_parts/design_button/pen.png" alt="Pen"></div>
          <div class="tool-button" data-tool="brush"><img src="../../create_parts/design_button/brush.png" alt="Brush"></div>
          <div class="tool-button" data-tool="eraser"><img src="../../create_parts/design_button/eraser.png" alt="Eraser"></div>
          <div class="tool-button" data-tool="rotate"><img src="../../create_parts/design_button/rotate.png" alt="Rotate"></div>
          <div class="tool-button" data-tool="percent"><img src="../../create_parts/design_button/percent.png" alt="Percent"></div>
          <div class="tool-button" data-tool="photo"><img src="../../create_parts/design_button/photo.png" alt="Camera"></div>
          <div class="tool-button" data-tool="add"><img src="../../create_parts/design_button/add.png" alt="Add"></div>
          <div class="tool-button" data-tool="shapes"><img src="../../create_parts/design_button/shapes.png" alt="Fill & Stroke"></div>
        </div>
      </div>

      <!-- カラーパネル -->
      <div id="color-panel" class="panel color-panel">
        <h2 class="panel-title">Color <button class="custom-button">Custom...</button></h2>
        <div id="color-grid" class="color-grid">
          <div class="color-box selected" style="background-color: #ffffff;" data-color="#ffffff"></div>
          <div class="color-box" style="background-color: #cccccc;" data-color="#cccccc"></div>
          <div class="color-box" style="background-color: #ffff00;" data-color="#ffff00"></div>
          <div class="color-box" style="background-color: #ff9900;" data-color="#ff9900"></div>
          <div class="color-box" style="background-color: #f4a2a2;" data-color="#f4a2a2"></div>
          <div class="color-box" style="background-color: #ff0000;" data-color="#ff0000"></div>
          <div class="color-box" style="background-color: #009900;" data-color="#009900"></div>
          <div class="color-box" style="background-color: #006600;" data-color="#006600"></div>
          <div class="color-box" style="background-color: #3399ff;" data-color="#3399ff"></div>
          <div class="color-box" style="background-color: #0000ff;" data-color="#0000ff"></div>
          <div class="color-box" style="background-color: #990099;" data-color="#990099"></div>
          <div class="color-box" style="background-color: #000000;" data-color="#000000"></div>
          <button class="color-box add-color-button">+</button>
          <button class="color-box add-color-button">+</button>
          <button class="color-box add-color-button">+</button>
          <button class="color-box eyedropper-button"><img src="../../color/pc_color/eyedropper.png" alt="Eyedropper"></button>
        </div>
      </div>
    </aside>
  </div>

  <!-- JS統合枠 -->
  <script>
/* =========================
   Minimal State Manager (Undo/Redo)
   ========================= */
const State = (() => {
  const undoStack = [];
  const redoStack = [];
  const MAX = 50;

  const snapshot = () => ({
    canvasHTML: document.getElementById('canvas-wrapper').innerHTML,
    gender: document.querySelector('.gender-button.active')?.dataset.gender || 'woman',
    mannequinSrc: document.getElementById('mannequin')?.getAttribute('src') || '',
    grid: document.getElementById('canvas-wrapper').classList.contains('grid-active')
  });

  const restore = (snap) => {
    const wrap = document.getElementById('canvas-wrapper');
    wrap.innerHTML = snap.canvasHTML;
    // 再バインド（オーバーレイにイベントを戻す）
    Layer.initSelectable();
    // grid
    wrap.classList.toggle('grid-active', snap.grid);
    // gender active 表示は見た目だけ合わせる
    document.querySelectorAll('.gender-button').forEach(b=>{
      b.classList.toggle('active', b.dataset.gender===snap.gender);
    });
  };

  const push = () => {
    undoStack.push(snapshot());
    if (undoStack.length > MAX) undoStack.shift();
    // 状態更新時には redo はクリア
    redoStack.length = 0;
  };

  const undo = () => {
    if (undoStack.length === 0) return;
    const current = snapshot();
    const prev = undoStack.pop();
    redoStack.push(current);
    restore(prev);
  };

  const redo = () => {
    if (redoStack.length === 0) return;
    const current = snapshot();
    const next = redoStack.pop();
    undoStack.push(current);
    restore(next);
  };

  return { push, undo, redo, snapshot };
})();

/* =========================
   Layer / Selection / Apply
   ========================= */
const Layer = (() => {
  let selectedEl = null;
  let activeColor = '#000000';

  const canvas = document.getElementById('canvas-wrapper');

  // 選択の見た目
  const select = (el) => {
    if (selectedEl) selectedEl.classList.remove('selected-layer');
    selectedEl = el;
    if (selectedEl) selectedEl.classList.add('selected-layer');
  };

  // クリックで選択できるようにする（オーバーレイ要素のみ）
  const initSelectable = () => {
    canvas.querySelectorAll('.overlay-item').forEach(el => {
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        select(el);
      });
    });
  };

  // 何も無いところをクリックで選択解除
  canvas.addEventListener('click', () => select(null));

  // カラー適用：SVGなら fill/ stroke、img/div なら filter or background
  const applyColor = (hex) => {
    activeColor = hex;
    if (!selectedEl) return;

    // SVG塗り（例：<svg>内の.paintable要素）
    if (selectedEl.tagName.toLowerCase() === 'svg') {
      selectedEl.querySelectorAll('.paintable').forEach(p => p.setAttribute('fill', hex));
      return;
    }
    // IMGやDIVに色のトーンを掛けたい場合：オーバーレイ用の tint を重ねる
    if (!selectedEl.querySelector(':scope > .tint')) {
      const tint = document.createElement('div');
      tint.className = 'tint';
      selectedEl.appendChild(tint);
    }
    selectedEl.querySelector(':scope > .tint').style.backgroundColor = hex + '80'; // 50%程度
  };

  // パーツ追加：data-part-src を持つツールボタンから画像をオーバーレイとして追加
  const addPart = (src) => {
    const holder = document.createElement('div');
    holder.className = 'overlay-item';
    holder.style.position = 'absolute';
    holder.style.left = '50%';
    holder.style.top = '50%';
    holder.style.transform = 'translate(-50%, -50%)';
    holder.style.width = '45%';
    holder.style.aspectRatio = '3/4'; // おおよそ
    holder.style.pointerEvents = 'auto';

    const img = document.createElement('img');
    img.src = src;
    img.alt = 'part';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'contain';
    holder.appendChild(img);

    // ドラッグ移動（最小限）
    let dragging = false, sx=0, sy=0, bx=0, by=0;
    holder.addEventListener('pointerdown', (e)=>{
      dragging = true;
      sx = e.clientX; sy = e.clientY;
      const rect = holder.getBoundingClientRect();
      const cRect = canvas.getBoundingClientRect();
      bx = rect.left - cRect.left; by = rect.top - cRect.top;
      holder.setPointerCapture(e.pointerId);
      select(holder);
    });
    holder.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const cRect = canvas.getBoundingClientRect();
      const nx = bx + (e.clientX - sx);
      const ny = by + (e.clientY - sy);
      holder.style.left = (nx + holder.offsetWidth/2)/cRect.width*100 + '%';
      holder.style.top  = (ny + holder.offsetHeight/2)/cRect.height*100 + '%';
      holder.style.transform = 'translate(-50%, -50%)';
    });
    holder.addEventListener('pointerup', ()=>{ dragging=false; State.push(); });

    canvas.appendChild(holder);
    select(holder);
  };

  return { initSelectable, select, applyColor, addPart, setActiveColor: (c)=>activeColor=c };
})();

/* =========================
   UI Wiring
   ========================= */
window.addEventListener('DOMContentLoaded', () => {
  // 初期状態を積む
  State.push();

  // Undo/Redo/Reset/Download/Upload/Save/Grid
  const q = (sel) => document.querySelector(sel);

  q('button[aria-label="Undo"]')?.addEventListener('click', () => State.undo());
  q('button[aria-label="Redo"]')?.addEventListener('click', () => State.redo());

  q('button[aria-label="Reset"]')?.addEventListener('click', () => {
    const mannequin = document.getElementById('mannequin');
    const wrap = document.getElementById('canvas-wrapper');
    wrap.innerHTML = '';
    const img = document.createElement('img');
    img.id = 'mannequin';
    img.className = 'mannequin-base';
    img.src = mannequin?.dataset?.defaultSrc || mannequin?.src || '../../mannequin/mannequin_woman.png';
    img.alt = 'Mannequin';
    wrap.appendChild(img);
    Layer.initSelectable();
    State.push();
  });

  q('button[aria-label="Download"]')?.addEventListener('click', () => {
    // 簡易：canvas-wrapper のHTMLを保存（実装軽量）
    const blob = new Blob([document.getElementById('canvas-wrapper').innerHTML], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'vivora-illustration.htmlfrag';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  q('button[aria-label="Upload"]')?.addEventListener('click', () => {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*,.svg';
    inp.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      // 画像/SVG をパーツとして追加
      Layer.addPart(url);
      State.push();
    };
    inp.click();
  });

  q('button[aria-label="Save"]')?.addEventListener('click', () => {
    // 簡易スナップショット保存
    localStorage.setItem('vivora-illustration-snap', JSON.stringify(State.snapshot()));
    alert('Saved locally.');
  });

  q('#grid-toggle')?.addEventListener('click', () => {
    const wrap = document.getElementById('canvas-wrapper');
    wrap.classList.toggle('grid-active');
    State.push();
  });

  // Gender 切替
  document.querySelectorAll('.gender-button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.gender-button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // とりあえず女性/男性/キッズでトルソー切替（パス例）
      const map = {
        woman: '../../mannequin/mannequin_woman.png',
        man: '../../mannequin/mannequin_man.png',
        kids: '../../mannequin/mannequin_kids.png'
      };
      const img = document.getElementById('mannequin');
      if (img && map[btn.dataset.gender]) {
        img.src = map[btn.dataset.gender];
        img.setAttribute('data-default-src', map[btn.dataset.gender]);
        State.push();
      }
    });
  });

  // Pose サムネ
  document.querySelectorAll('.pose-thumb').forEach(ph=>{
    ph.addEventListener('click', ()=>{
      document.querySelectorAll('.pose-thumb').forEach(p=>p.classList.remove('selected'));
      ph.classList.add('selected');
      const src = ph.dataset.poseSrc;
      const img = document.getElementById('mannequin');
      if (img && src) {
        img.src = src;
        img.setAttribute('data-default-src', src);
        State.push();
      }
    });
  });

  // Stationery のうち、data-part-src があればパーツ追加として動作
  document.querySelectorAll('.tool-button').forEach(tb=>{
    tb.addEventListener('click', ()=>{
      const src = tb.dataset.partSrc;
      if (src) { Layer.addPart(src); State.push(); }
    });
  });

  // Color パネル
  document.querySelectorAll('.color-box').forEach(cb=>{
    cb.addEventListener('click', ()=>{
      const color = cb.dataset.color;
      if (!color) return;
      document.querySelectorAll('.color-box').forEach(x=>x.classList.remove('selected'));
      cb.classList.add('selected');
      Layer.applyColor(color);
      State.push();
    });
  });

  // 初期：既存のオーバーレイに選択機能を付与
  Layer.initSelectable();
});
</script>

  </script>
</body>
</html>
