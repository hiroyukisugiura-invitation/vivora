<!DOCTYPE html>
<html lang="ja" data-theme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vivora Fashion Illustration 2025</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="viewport">
    <div class="app" role="application" aria-label="Vivora Fashion Illustration 2025">

      <!-- 1段目：左にタイトル、右にhistory（stationery右端に同期） -->
      <header class="top-strip">
        <h1 class="title">Vivora Fashion Illustration 2025</h1>
        <div class="history-tool" aria-label="history">
          <img src="/create_parts/create_button/retreat.png"  alt="Redo"     title="戻る" draggable="false"/>
          <img src="/create_parts/create_button/forward.png"  alt="Cycle"    title="進む" draggable="false"/>
          <img src="/create_parts/create_button/reset.png"    alt="Undo"     title="リセット" draggable="false"/>
          <img src="/create_parts/create_button/download.png" alt="Download" title="ダウンロード" draggable="false"/>
          <img src="/create_parts/create_button/upload.png"   alt="Upload"   title="アップロード" draggable="false"/>
          <img src="/create_parts/create_button/save.png"     alt="Save"     title="保存" draggable="false"/>
        </div>
      </header>

      <!-- 2段目：Next Step + contents（タイトルの下に1マス空けて配置） -->
      <div class="nav-strip">
        <button id="next-step" class="ghost-btn" type="button">Next Step ▶▶</button>
        <nav class="contents-button" aria-label="contents">
          <img src="/create_parts/contents_button/0_home.png" alt="Home"  title="Home" draggable="false"/>
          <img src="/create_parts/contents_button/1_fashion-illustrations.png" alt="Fi"  title="Fashion Illustrations" draggable="false"/>
          <img src="/create_parts/contents_button/2_fabric-matching.png"       alt="Fm"  title="Fabric Matching" draggable="false"/>
          <img src="/create_parts/contents_button/3_clothing-design.png"        alt="Cd"  title="Clothing Design" draggable="false"/>
          <img src="/create_parts/contents_button/4_pattern-creation.png"       alt="Pc"  title="Pattern Creation" draggable="false"/>
          <img src="/create_parts/contents_button/5_grading.png"                alt="Gd"  title="Grading" draggable="false"/>
          <img src="/create_parts/contents_button/6_print-layout-cut.png"       alt="Plc" title="Print/Layout/Cut" draggable="false"/>
          <img src="/create_parts/contents_button/digital-dressing-kids-mode.png" alt="Dk" title="Digital Dressing (Kids)" draggable="false"/>
        </nav>
      </div>

      <!-- キャンバス -->
      <main class="board" role="main">
        <div class="canvas-wrapper" id="canvas">
          <!-- Stationery（枠なし） -->
          <div class="stationery-toolbar" id="stationery" aria-label="stationery">
            <img src="/create_parts/object_btn/select.png"      alt="Select"  title="選択" draggable="false"/>
            <img src="/create_parts/object_btn/square.png"      alt="Square"  title="図形" draggable="false"/>
            <img src="/create_parts/object_btn/brush.png"       alt="Brush"   title="ペン" draggable="false"/>
            <img src="/create_parts/object_btn/eraser.png"      alt="Eraser"  title="ケシゴム" draggable="false"/>
            <img src="/create_parts/object_btn/sentence.png"    alt="Text"    title="テキスト" draggable="false"/>
            <img src="/create_parts/object_btn/opasity_ber.png" alt="Opacity" title="透明度" draggable="false"/>
            <img src="/create_parts/object_btn/graph_paper.png" alt="Grid"    title="方眼紙" draggable="false"/>
            <img src="/create_parts/object_btn/layer.png"       alt="Layer"   title="レイヤー" draggable="false"/>
          </div>

          <!-- マネキン（スムーズピンチ＋二本指パン） -->
          <div id="man-zoom">
            <img id="mannequin"
                 src="/mannequin/mannequin_woman/mannequin_woman_front.png"
                 alt="Mannequin (Woman Front)" draggable="false"/>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ===== 1) ステージ自動フィット（整数pxスナップ） =====
    (function(){
      const css = () => getComputedStyle(document.documentElement);
      const num = v => parseFloat(v) || 0;

      function snapScale(baseW, baseH, vw, vh){
        const raw = Math.max(0.5, Math.min(vw/baseW, vh/baseH));
        const wSnap = Math.floor(baseW * raw);
        const hSnap = Math.floor(baseH * raw);
        let s = Math.min(wSnap/baseW, hSnap/baseH);
        const dpr = window.devicePixelRatio || 1;
        s = Math.round(s * dpr * 2) / (dpr * 2); // 0.5/DPR刻み
        return Math.max(0.5, s);
      }

      function fit(){
        const W = num(css().getPropertyValue('--base-w')) || 1280;
        const H = num(css().getPropertyValue('--base-h')) || 820;
        const M = num(css().getPropertyValue('--viewport-margin')) || 24;
        const vw = window.innerWidth  - M*2;
        const vh = window.innerHeight - M*2;
        const s  = snapScale(W,H,vw,vh);
        document.documentElement.style.setProperty('--app-scale', s);
      }
      addEventListener('resize', fit, {passive:true});
      addEventListener('orientationchange', fit, {passive:true});
      document.addEventListener('DOMContentLoaded', fit);
    })();

    // ===== 2) History の右端を Stationery の右端に同期 =====
    (function(){
      function sync(){
        const canvas = document.getElementById('canvas');
        const st = document.getElementById('stationery');
        const hist = document.querySelector('.history-tool');
        if(!canvas || !st || !hist) return;
        const c = canvas.getBoundingClientRect();
        const s = st.getBoundingClientRect();
        const boardPad = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--board-pad'))||14;
        const gap = Math.max(0, Math.round(c.right - s.right));
        hist.style.marginRight = `${gap + boardPad}px`;
      }
      addEventListener('resize', sync, {passive:true});
      addEventListener('load', sync, {passive:true});
      new ResizeObserver(sync).observe(document.body);
    })();

    // ===== 3) 画像ドラッグ抑止 =====
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('img').forEach(img=>{
        img.addEventListener('mousedown', e=>e.preventDefault());
        img.addEventListener('dragstart', e=>e.preventDefault());
      });
    });

    // ===== 4) テーマ切替（light/dark/system） =====
    (function(){
      const KEY='vivora.theme', root=document.documentElement;
      function apply(t){ root.setAttribute('data-theme', t); }
      window.setTheme = t=>{
        if(!['light','dark','system'].includes(t)) return;
        localStorage.setItem(KEY,t); apply(t);
      };
      apply(localStorage.getItem(KEY)||'system');
      matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change',()=>{ if(root.getAttribute('data-theme')==='system') apply('system'); });
    })();

    // ===== 5) マネキン：スムーズピンチ＋二本指パン =====
    (function(){
      const wrap   = document.getElementById('man-zoom');
      const canvas = document.getElementById('canvas');

      let scale=1, targetScale=1;
      let panX=0, targetPanX=0;
      let panY=0, targetPanY=0;
      const MIN=0.5, MAX=4;

      const apply = ()=>{
        wrap.style.setProperty('--man-scale', scale);
        wrap.style.setProperty('--man-x', panX+'px');
        wrap.style.setProperty('--man-y', panY+'px');
      };

      // 慣性イージング
      let raf=null;
      function animate(){
        scale += (targetScale-scale)*0.20;
        panX  += (targetPanX -panX )*0.20;
        panY  += (targetPanY -panY )*0.20;
        apply();
        if (Math.abs(targetScale-scale)<0.0005 && Math.abs(targetPanX-panX)<0.1 && Math.abs(targetPanY-panY)<0.1){
          cancelAnimationFrame(raf); raf=null; return;
        }
        raf=requestAnimationFrame(animate);
      }
      const tick=()=>{ if(!raf) raf=requestAnimationFrame(animate); };

      const setScale=s=>{ targetScale=Math.min(MAX,Math.max(MIN,s)); tick(); };
      const addPan=(dx,dy)=>{ targetPanX+=dx; targetPanY+=dy; tick(); };

      // Ctrl+Wheel = ピンチ、2本指スクロール = パン
      canvas.addEventListener('wheel', (e)=>{
        if (e.ctrlKey){
          e.preventDefault();
          setScale(targetScale * Math.exp(-e.deltaY*0.002));
        }else{
          addPan(-e.deltaX, -e.deltaY);
        }
      }, {passive:false});

      // Safari gesture
      let gBase=1;
      addEventListener('gesturestart', ()=>{ gBase=targetScale; }, {passive:true});
      addEventListener('gesturechange', (e)=>{
        e.preventDefault();
        setScale(gBase * e.scale);
      }, {passive:false});

      // タッチピンチ＆パン
      let t0=null, base=1;
      const dist=(a,b)=>Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
      const mid =(a,b)=>({x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2});
      canvas.addEventListener('touchstart', e=>{
        if(e.touches.length===2){
          const [a,b]=e.touches; t0={d:dist(a,b), c:mid(a,b)}; base=targetScale;
        }
      }, {passive:true});
      canvas.addEventListener('touchmove', e=>{
        if(e.touches.length===2 && t0){
          e.preventDefault();
          const [a,b]=e.touches; const d=dist(a,b), c=mid(a,b);
          setScale(base * (d/t0.d));
          addPan((c.x - t0.c.x),(c.y - t0.c.y));
        }
      }, {passive:false});
      canvas.addEventListener('touchend', ()=>{ t0=null; }, {passive:true});

      // マウスドラッグ（任意・有効）
      let drag=false, mx=0,my=0;
      wrap.addEventListener('mousedown', e=>{ drag=true; mx=e.clientX; my=e.clientY; e.preventDefault(); });
      addEventListener('mousemove', e=>{ if(!drag) return; addPan(e.clientX-mx, e.clientY-my); mx=e.clientX; my=e.clientY; });
      addEventListener('mouseup',   ()=>{ drag=false; });

      // ダブルクリック/タップでリセット
      let last=0;
      canvas.addEventListener('click', e=>{
        const now=Date.now(); if(now-last<300){ targetScale=1; targetPanX=0; targetPanY=0; tick(); } last=now;
      });

      apply();
    })();
  </script>
</body>
</html>
