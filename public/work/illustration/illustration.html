<!DOCTYPE html>
<html lang="ja" data-theme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vivora Fashion Illustration 2025</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="viewport">
    <div class="app" role="application" aria-label="Vivora Fashion Illustration 2025">

      <!-- 1ÊÆµÁõÆÔºö„Çø„Ç§„Éà„É´Â∑¶ / historyÂè≥ -->
      <header class="top-strip">
        <h1 class="title">Vivora Fashion Illustration 2025</h1>
        <div class="history-tool" aria-label="history">
          <img src="/create_parts/create_button/retreat.png"  alt="Êàª„Çã"     title="Êàª„Çã" draggable="false"/>
          <img src="/create_parts/create_button/forward.png"  alt="ÈÄ≤„ÇÄ"     title="ÈÄ≤„ÇÄ" draggable="false"/>
          <img src="/create_parts/create_button/reset.png"    alt="„É™„Çª„ÉÉ„Éà" title="„É™„Çª„ÉÉ„Éà" draggable="false"/>
          <img src="/create_parts/create_button/download.png" alt="DL"       title="„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ" draggable="false"/>
          <img src="/create_parts/create_button/upload.png"   alt="UP"       title="„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ" draggable="false"/>
          <img src="/create_parts/create_button/save.png"     alt="‰øùÂ≠ò"     title="‰øùÂ≠ò" draggable="false"/>
        </div>
      </header>

      <!-- 2ÊÆµÁõÆÔºöNext Step + contents -->
      <div class="nav-strip">
        <button id="next-step" class="ghost-btn" type="button">Next Step ‚ñ∂‚ñ∂</button>
        <nav class="contents-button" aria-label="contents">
          <img src="/create_parts/contents_button/0_home.png" alt="Home"  title="Home" draggable="false"/>
          <img src="/create_parts/contents_button/1_fashion-illustrations.png" alt="Fi"  title="Fashion Illustrations" draggable="false"/>
          <img src="/create_parts/contents_button/2_fabric-matching.png"       alt="Fm"  title="Fabric Matching" draggable="false"/>
          <img src="/create_parts/contents_button/3_clothing-design.png"        alt="Cd"  title="Clothing Design" draggable="false"/>
          <img src="/create_parts/contents_button/4_pattern-creation.png"       alt="Pc"  title="Pattern Creation" draggable="false"/>
          <img src="/create_parts/contents_button/5_grading.png"                alt="Gd"  title="Grading" draggable="false"/>
          <img src="/create_parts/contents_button/6_print-layout-cut.png"       alt="Plc" title="Print/Layout/Cut" draggable="false"/>
          <img src="/create_parts/contents_button/digital-dressing-kids-mode.png" alt="Dk" title="Digital Dressing (Kids)" draggable="false"/>
        </nav>
      </div>

      <!-- „Ç≠„É£„É≥„Éê„Çπ -->
      <main class="board" role="main">
        <div class="canvas-wrapper" id="canvas">
          <!-- StationeryÔºàÂè≥‰∏äÔºâ -->
          <div class="stationery-toolbar" id="stationery" aria-label="stationery">

            <!-- ‚ñº „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Éà„É™„Ç¨„ÉºÔºàSelectÔºâ -->
            <button class="tool-trigger" id="trigger-select"
              aria-haspopup="menu" aria-expanded="false" data-tool="select" title="Select (V)">
              <img id="icon-select-current" src="/create_parts/object_btn/select.png" alt="Select" draggable="false">
              <span class="caret"></span>
            </button>

            <!-- ‚ñº „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Éà„É™„Ç¨„ÉºÔºàBoxÔºâ -->
            <button class="tool-trigger" id="trigger-box"
              aria-haspopup="menu" aria-expanded="false" data-tool="box" title="Shape (M)">
              <img id="icon-box-current" src="/create_parts/object_btn/square.png" alt="Box" draggable="false">
              <span class="caret"></span>
            </button>

            <!-- ‚ñº „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Éà„É™„Ç¨„ÉºÔºàPenÔºâ -->
            <button class="tool-trigger" id="trigger-pen"
              aria-haspopup="menu" aria-expanded="false" data-tool="pen" title="Pen/Brush (B)">
              <img id="icon-pen-current" src="/create_parts/object_btn/brush.png" alt="Pen" draggable="false">
              <span class="caret"></span>
            </button>

            <!-- ‰ª•Èôç„ÅØ‚Äú„ÅÑ„Å§„ÇÇ„ÅÆÔºòÈ†ÖÁõÆ‚Äù„ÅÆÊÆã„ÇäÔºàÁã¨Á´ã„Ç¢„Ç§„Ç≥„É≥Ôºâ -->
            <img src="/create_parts/object_btn/eraser.png"     alt="Eraser" title="Ê∂à„Åó„Ç¥„É† (E)" draggable="false" data-quick="eraser"/>
            <img src="/create_parts/object_btn/sentence.png"   alt="Text"   title="„ÉÜ„Ç≠„Çπ„Éà (T)" draggable="false" data-quick="text"/>
            <img src="/create_parts/object_btn/opasity_ber.png" alt="Opacity" title="‰∏çÈÄèÊòéÂ∫¶ (O)" draggable="false" data-quick="opacity"/>
            <img src="/create_parts/object_btn/graph_paper.png" alt="Grid"    title="ÊñπÁúºÁ¥ô" draggable="false" data-quick="grid"/>
            <img src="/create_parts/object_btn/layer.png"       alt="Layer"   title="„É¨„Ç§„É§„Éº" draggable="false" data-quick="layer"/>
          </div>

          <!-- ‚ñº „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ÔºöSelect -->
          <div class="dropdown hide" id="menu-select" role="menu" aria-label="Select menu">
            <!-- role="menuitemradio" „ÅßÈÅ∏ÊäûÁä∂ÊÖã„ÇíË°®Áèæ -->
            <button class="menuitem" role="menuitemradio" data-sub="select"    data-icon="/create_parts/object_btn/select.png"  title="ÈÄöÂ∏∏ÈÅ∏Êäû (V)">
              <img src="/create_parts/object_btn/select.png" alt="">
              <span>ÈÄöÂ∏∏ÈÅ∏Êäû</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="direct"    data-icon="/create_parts/object_btn/direct_select.png" title="„ÉÄ„Ç§„É¨„ÇØ„ÉàÈÅ∏Êäû (A)">
              <img src="/create_parts/object_btn/direct_select.png" alt="">
              <span>„ÉÄ„Ç§„É¨„ÇØ„Éà</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="lasso"     data-icon="/create_parts/object_btn/lasso.png" title="„Å™„Åí„Å™„Çè (L)">
              <img src="/create_parts/object_btn/lasso.png" alt="">
              <span>„Å™„Åí„Å™„Çè</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="polygon"   data-icon="/create_parts/object_btn/polygon_select.png" title="Â§öËßíÂΩ¢ÈÅ∏Êäû">
              <img src="/create_parts/object_btn/polygon_select.png" alt="">
              <span>Â§öËßíÂΩ¢ÈÅ∏Êäû</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="group"     data-icon="/create_parts/object_btn/group_select.png" title="„Ç∞„É´„Éº„ÉóÈÅ∏Êäû">
              <img src="/create_parts/object_btn/group_select.png" alt="">
              <span>„Ç∞„É´„Éº„ÉóÈÅ∏Êäû</span>
            </button>
            <label class="pin"><input type="checkbox" id="pin-select">üìå Âõ∫ÂÆö</label>
          </div>

          <!-- ‚ñº „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ÔºöBoxÔºàÂõ≥ÂΩ¢Ôºâ -->
          <div class="dropdown hide" id="menu-box" role="menu" aria-label="Box menu">
            <button class="menuitem" role="menuitemradio" data-sub="rect"     data-icon="/create_parts/object_btn/square.png" title="Èï∑ÊñπÂΩ¢ (M)">
              <img src="/create_parts/object_btn/square.png" alt=""><span>Èï∑ÊñπÂΩ¢</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="roundrect" data-icon="/create_parts/object_btn/roundrect.png" title="Ëßí‰∏∏">
              <img src="/create_parts/object_btn/roundrect.png" alt=""><span>Ëßí‰∏∏</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="ellipse"  data-icon="/create_parts/object_btn/ellipse.png" title="Ê•ïÂÜÜ / Ê≠£ÂÜÜ (O)">
              <img src="/create_parts/object_btn/ellipse.png" alt=""><span>Ê•ïÂÜÜ</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="triangle" data-icon="/create_parts/object_btn/triangle.png" title="‰∏âËßíÂΩ¢">
              <img src="/create_parts/object_btn/triangle.png" alt=""><span>‰∏âËßíÂΩ¢</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="line"     data-icon="/create_parts/object_btn/line.png" title="Áõ¥Á∑ö">
              <img src="/create_parts/object_btn/line.png" alt=""><span>Áõ¥Á∑ö</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="arrow"    data-icon="/create_parts/object_btn/arrow.png" title="Áü¢Âç∞">
              <img src="/create_parts/object_btn/arrow.png" alt=""><span>Áü¢Âç∞</span>
            </button>
            <label class="pin"><input type="checkbox" id="pin-box">üìå Âõ∫ÂÆö</label>
          </div>

          <!-- ‚ñº „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ÔºöPenÔºà„Éö„É≥Á®ÆÔºâ -->
          <div class="dropdown hide" id="menu-pen" role="menu" aria-label="Pen menu">
            <button class="menuitem" role="menuitemradio" data-sub="pencil" data-icon="/create_parts/object_btn/pencil.png" title="ÈâõÁ≠Ü">
              <img src="/create_parts/object_btn/pencil.png" alt=""><span>ÈâõÁ≠Ü</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="brush"  data-icon="/create_parts/object_btn/brush.png" title="„Éñ„É©„Ç∑ (B)">
              <img src="/create_parts/object_btn/brush.png" alt=""><span>„Éñ„É©„Ç∑</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="marker" data-icon="/create_parts/object_btn/marker.png" title="„Éû„Éº„Ç´„Éº">
              <img src="/create_parts/object_btn/marker.png" alt=""><span>„Éû„Éº„Ç´„Éº</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="pen"    data-icon="/create_parts/object_btn/pen.png" title="„Å§„Åë„Éö„É≥ (P)">
              <img src="/create_parts/object_btn/pen.png" alt=""><span>„Å§„Åë„Éö„É≥</span>
            </button>
            <button class="menuitem" role="menuitemradio" data-sub="eraser" data-icon="/create_parts/object_btn/eraser.png" title="Ê∂à„Åó„Ç¥„É† (E)">
              <img src="/create_parts/object_btn/eraser.png" alt=""><span>Ê∂à„Åó„Ç¥„É†</span>
            </button>
            <label class="pin"><input type="checkbox" id="pin-pen">üìå Âõ∫ÂÆö</label>
          </div>

          <!-- ‚ñº „Éö„É≥Áî®Ôºö„Ç´„É©„ÉºÁ∏¶„Éë„Éç„É´ÔºàËá™ÂãïË°®Á§∫Ôºâ -->
          <aside id="color-panel" class="color-panel hide" aria-label="Color panel">
            <!-- 12Ëâ≤ÔºàÈ†ÜÂ∫è„ÅØ„Çπ„ÇØ„Ç∑„ÉßÊ∫ñÊã†Ôºâ -->
            <button class="swatch" data-color="#FFFFFF" title="White"></button>
            <button class="swatch" data-color="#8E8E8E" title="Gray"></button>
            <button class="swatch" data-color="#FFD400" title="Yellow"></button>
            <button class="swatch" data-color="#F39C12" title="Orange"></button>
            <button class="swatch" data-color="#F5A3A3" title="Pink"></button>
            <button class="swatch" data-color="#E31E24" title="Red"></button>
            <button class="swatch" data-color="#5EC255" title="Light Green"></button>
            <button class="swatch" data-color="#0E7F54" title="Green"></button>
            <button class="swatch" data-color="#89C7E7" title="Sky"></button>
            <button class="swatch" data-color="#0C4DB7" title="Blue"></button>
            <button class="swatch" data-color="#6E2C91" title="Purple"></button>
            <button class="swatch" data-color="#8C2A24" title="Brown"></button>
            <button class="swatch" data-color="#6B6B6B" title="Dark Gray"></button>
            <button class="swatch" data-color="#000000" title="Black"></button>

            <button class="swatch add" data-action="add" title="Ëâ≤„ÇíËøΩÂä†">+</button>
            <button class="swatch pick" data-action="eyedrop" title="„Çπ„Éù„Ç§„Éà">
              <img src="/create_parts/object_btn/eyedropper.png" alt="">
            </button>
          </aside>

          <!-- ‚ñº ‰∏çÈÄèÊòéÂ∫¶ HUD -->
          <div id="opacity-hud" class="opacity-hud hide" role="dialog" aria-label="Opacity">
            <div class="hud-row">
              <span id="opacity-label">100 %</span>
              <button id="opacity-pin" class="hud-pin" title="Âõ∫ÂÆö">üìå</button>
            </div>
            <input id="opacity-range" type="range" min="0" max="100" value="100" step="1" />
          </div>

          <!-- „Éû„Éç„Ç≠„É≥Ôºà„Éî„É≥„ÉÅÔºÜ‰∫åÊú¨Êåá„Éë„É≥Ôºâ -->
          <div id="man-zoom">
            <img id="mannequin"
                 src="/mannequin/mannequin_woman/mannequin_woman_front.png"
                 alt="Mannequin (Woman Front)" draggable="false"/>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ===============================
    // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖãÔºà‰∏≠Â§ÆÁÆ°ÁêÜÔºâ
    // ===============================
    const state = {
      currentTool: 'select',     // 'select' | 'box' | 'pen' | quick-tools...
      subTool:     { select:'select', box:'rect', pen:'brush' }, // ÂêÑ„Ç∞„É´„Éº„Éó„ÅÆÁõ¥Ëøë
      color: '#000000',          // „Éö„É≥„ÅÆÂ°ó„ÇäËâ≤ÔºàÂàùÊúüÔºöÈªíÔºâ
      opacity: 100,              // 0-100 (%)
      timers: { hud: null },     // HUDËá™Âãï„ÇØ„É≠„Éº„Ç∫Áî®
    };

    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
    const $  = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const hide = el => el.classList.add('hide');
    const show = el => el.classList.remove('hide');

    // ===============================
    // „Çπ„ÉÜ„Éº„Ç∏Ëá™Âãï„Éï„Ç£„ÉÉ„ÉàÔºàÊó¢Â≠òÔºâ
    // ===============================
    (function(){
      const css = () => getComputedStyle(document.documentElement);
      const num = v => parseFloat(v) || 0;
      function snapScale(baseW, baseH, vw, vh){
        const raw = Math.max(0.5, Math.min(vw/baseW, vh/baseH));
        const wSnap = Math.floor(baseW * raw);
        const hSnap = Math.floor(baseH * raw);
        let s = Math.min(wSnap/baseW, hSnap/baseH);
        const dpr = window.devicePixelRatio || 1;
        s = Math.round(s * dpr * 2) / (dpr * 2);
        return Math.max(0.5, s);
      }
      function fit(){
        const W = num(css().getPropertyValue('--base-w')) || 1280;
        const H = num(css().getPropertyValue('--base-h')) || 820;
        const M = num(css().getPropertyValue('--viewport-margin')) || 24;
        const vw = window.innerWidth  - M*2;
        const vh = window.innerHeight - M*2;
        document.documentElement.style.setProperty('--app-scale', snapScale(W,H,vw,vh));
      }
      addEventListener('resize', fit, {passive:true});
      addEventListener('orientationchange', fit, {passive:true});
      document.addEventListener('DOMContentLoaded', fit);
    })();

    // ===============================
    // History „ÅÆÂè≥Á´Ø„Çí Stationery „Å´ÂêåÊúüÔºàÊó¢Â≠òÔºâ
    // ===============================
    (function(){
      function sync(){
        const canvas = $('#canvas');
        const st = $('#stationery');
        const hist = document.querySelector('.history-tool');
        if(!canvas || !st || !hist) return;
        const c = canvas.getBoundingClientRect();
        const s = st.getBoundingClientRect();
        const boardPad = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--board-pad'))||14;
        const gap = Math.max(0, Math.round(c.right - s.right));
        hist.style.marginRight = `${gap + boardPad}px`;
      }
      addEventListener('resize', sync, {passive:true});
      addEventListener('load', sync, {passive:true});
      new ResizeObserver(sync).observe(document.body);
    })();

    // ===============================
    // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ ÂÖ±ÈÄöÊåôÂãï
    // ===============================
    const triggers = $$('.tool-trigger');
    const menus = {
      select: $('#menu-select'),
      box:    $('#menu-box'),
      pen:    $('#menu-pen')
    };
    const icons = {
      select: $('#icon-select-current'),
      box:    $('#icon-box-current'),
      pen:    $('#icon-pen-current')
    };
    const pins = {
      select: $('#pin-select'),
      box:    $('#pin-box'),
      pen:    $('#pin-pen')
    };

    function closeAllMenus(exceptName){
      for(const [name, menu] of Object.entries(menus)){
        if(name === exceptName && pins[name]?.checked) continue; // „Éî„É≥Âõ∫ÂÆö„ÅØÈñâ„Åò„Å™„ÅÑ
        hide(menu);
        const trg = document.querySelector(`.tool-trigger[data-tool="${name}"]`);
        trg?.setAttribute('aria-expanded','false');
      }
    }

    function openMenu(name, triggerEl){
      const menu = menus[name];
      if(!menu) return;
      closeAllMenus(name);
      positionMenuUnderTrigger(menu, triggerEl);
      show(menu);
      triggerEl.setAttribute('aria-expanded','true');
      // „É°„Éã„É•„ÉºÂÜÖÂÖàÈ†≠„Å´„Éï„Ç©„Éº„Ç´„Çπ
      const first = menu.querySelector('.menuitem');
      first?.focus({preventScroll:true});
    }

    function positionMenuUnderTrigger(menu, triggerEl){
      // „Éà„É™„Ç¨„Éº„ÅÆÁúü‰∏ã„Å´„Ç´„Éº„Éâ„ÇíÂá∫„ÅôÔºà„Çπ„ÉÜ„Éº„Ç∑„Éß„Éä„É™„Éº„ÅØabsoluteÂÜÖ„Å´„ÅÇ„ÇãÔºâ
      const toolBar = $('#stationery').getBoundingClientRect();
      const t = triggerEl.getBoundingClientRect();
      const parent = $('#stationery').offsetParent.getBoundingClientRect();
      // Ë¶™Âü∫Ê∫ñ„Ç™„Éï„Çª„ÉÉ„Éà
      menu.style.left = (t.left - parent.left) + 'px';
      menu.style.top  = (t.bottom - parent.top + 6) + 'px'; // „Åª„Çì„ÅÆÂ∞ë„Åó‰∏ã„Åí„Çã
    }

    // „ÇØ„É™„ÉÉ„ÇØ/Èï∑Êäº„Åó
    triggers.forEach(trg=>{
      let pressTimer=null;
      trg.addEventListener('mousedown', e=>{
        pressTimer = setTimeout(()=>openMenu(trg.dataset.tool, trg), 400); // Èï∑Êäº„Åó„ÅßÈñã„Åè
      });
      trg.addEventListener('mouseup', e=>{
        clearTimeout(pressTimer);
      });
      trg.addEventListener('click', e=>{
        // Áü≠Êäº„ÅóÔºöÁõ¥Ëøë„Çµ„Éñ„ÉÑ„Éº„É´„Å´Âç≥ÂàáÊõøÔºà=ÈÄöÂ∏∏„ÅÆ8„Ç¢„Ç§„Ç≥„É≥Áä∂ÊÖã„ÅÆ„Åæ„ÅæÔºâ
        const name = trg.dataset.tool;
        state.currentTool = name;
        // „Éö„É≥„ÅÆÂ†¥Âêà„ÅØ„Ç´„É©„Éº/HUD„ÇíÂëº„Å≥Âá∫„Åô
        if(name === 'pen'){
          showColorAndHud();
        }
      });
    });

    // „É°„Éã„É•„ÉºÈ†ÖÁõÆÈÅ∏Êäû ‚Üí „Çµ„Éñ„ÉÑ„Éº„É´Ë®òÊÜ∂ ‚Üí „Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞ ‚Üí Èñâ„Åò„Çã ‚ÜíÔºà„Éö„É≥„Å™„ÇâËâ≤HUDÔºâ
    $$('.dropdown .menuitem').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const menuEl = btn.closest('.dropdown');
        const group = menuEl.id.replace('menu-',''); // select | box | pen
        const sub   = btn.dataset.sub;
        const icon  = btn.dataset.icon;

        state.currentTool = group;
        state.subTool[group] = sub;
        if(icons[group] && icon){ icons[group].src = icon; }

        if(!pins[group]?.checked){ hide(menuEl); }
        document.querySelector(`.tool-trigger[data-tool="${group}"]`)
          ?.setAttribute('aria-expanded','false');

        if(group === 'pen'){ showColorAndHud(); }
      });
    });

    // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÉªEsc „ÅßÈñâ„Åò„ÇãÔºà„Éî„É≥Âõ∫ÂÆö„ÅØÈñâ„Åò„Å™„ÅÑÔºâ
    document.addEventListener('click', (e)=>{
      const within = e.target.closest('.dropdown, .tool-trigger, #color-panel, #opacity-hud');
      if(!within){ closeAllMenus(); hideColorPanel(); maybeHideHUD(true); }
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){ closeAllMenus(); hideColorPanel(); maybeHideHUD(true); }
    });

    // ===============================
    // „Ç´„É©„ÉºÁ∏¶„Éë„Éç„É´ÔºÜ ‰∏çÈÄèÊòéÂ∫¶ HUD
    // ===============================
    const colorPanel = $('#color-panel');
    const opacityHUD = $('#opacity-hud');
    const opacityLabel = $('#opacity-label');
    const opacityRange = $('#opacity-range');
    const opacityPin   = $('#opacity-pin');

    function showColorAndHud(){
      // „Ç´„É©„Éº„ÅØ„Çπ„ÉÜ„Éº„Ç∑„Éß„Éä„É™„Éº„ÅÆÂ∑¶‰∏ã„Åã„Çâ„Çπ„É©„Ç§„Éâ„Ç§„É≥
      positionColorPanel();
      show(colorPanel);
      // HUD„ÅØ„Ç´„É©„ÉºÂàó„ÅÆÂè≥ËÇ©„Å´ÈÖçÁΩÆ
      positionHUD();
      show(opacityHUD);
      resetHudTimer(); // 2Áßí„ÅßËá™ÂãïÈñâ„ÅòÔºà„Éî„É≥ON„Å™„ÇâÈñâ„Åò„Å™„ÅÑÔºâ
    }
    function hideColorPanel(){ hide(colorPanel); }

    function positionColorPanel(){
      const st = $('#stationery').getBoundingClientRect();
      const parent = $('#canvas').getBoundingClientRect();
      colorPanel.style.left = (st.left - parent.left) + 'px';
      colorPanel.style.top  = (st.bottom - parent.top + 10) + 'px';
    }
    function positionHUD(){
      const cp = colorPanel.getBoundingClientRect();
      const parent = $('#canvas').getBoundingClientRect();
      opacityHUD.style.left = (cp.right - parent.left + 16) + 'px';
      opacityHUD.style.top  = (cp.top   - parent.top + 8) + 'px';
    }

    // 2ÁßíÁÑ°Êìç‰Ωú„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÔºà„Éî„É≥Âõ∫ÂÆö„ÅØÁ∂≠ÊåÅÔºâ
    function resetHudTimer(){
      clearTimeout(state.timers.hud);
      state.timers.hud = setTimeout(()=> maybeHideHUD(false), 2000);
    }
    function maybeHideHUD(force){
      // force=true „Å™„ÇâÂº∑Âà∂Èñâ„Åò
      const pinned = opacityPin.classList.contains('on');
      if(force || !pinned){ hide(opacityHUD); hide(colorPanel); }
    }

    // „Ç´„É©„ÉºÈÅ∏Êäû
    $$('#color-panel .swatch').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act = btn.dataset.action;
        if(act === 'add'){
          // Â∞ÜÊù•Ôºö„Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„ÇíÈñã„ÅèÔºàÊö´ÂÆö„ÅØÈªí„Å´Êàª„ÅôÔºâ
          state.color = '#000000';
        }else if(act === 'eyedrop'){
          // Â∞ÜÊù•Ôºö„Çπ„Éù„Ç§„Éà„É¢„Éº„ÉâÈñãÂßãÔºàÊö´ÂÆö„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºâ
        }else{
          state.color = btn.dataset.color;
          // „Åì„Åì„ÅßÊèèÁîª„É¢„Ç∏„É•„Éº„É´„Å´ÈÄöÁü•„Åô„ÇãÊÉ≥ÂÆöÔºàemitÔºâ
        }
        resetHudTimer();
      });
    });

    // ‰∏çÈÄèÊòéÂ∫¶
    opacityRange.addEventListener('input', ()=>{
      state.opacity = parseInt(opacityRange.value,10);
      opacityLabel.textContent = `${state.opacity} %`;
      resetHudTimer();
    });
    opacityPin.addEventListener('click', ()=>{
      opacityPin.classList.toggle('on');
      opacityPin.title = opacityPin.classList.contains('on') ? 'Âõ∫ÂÆö‰∏≠' : 'Âõ∫ÂÆö';
    });

    // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÔºà‰∏ªË¶Å„ÅÆ„ÅøÔºâ
    document.addEventListener('keydown', (e)=>{
      if(e.target.closest('input, textarea, [contenteditable="true"]')) return;

      const k = e.key.toLowerCase();
      if(k === 'v'){ state.currentTool = 'select'; icons.select.src = '/create_parts/object_btn/select.png'; }
      if(k === 'a'){ state.currentTool = 'select'; state.subTool.select = 'direct'; icons.select.src = '/create_parts/object_btn/direct_select.png'; }
      if(k === 'l'){ state.currentTool = 'select'; state.subTool.select = 'lasso';  icons.select.src = '/create_parts/object_btn/lasso.png'; }
      if(k === 'm'){ state.currentTool = 'box';    state.subTool.box    = 'rect';   icons.box.src    = '/create_parts/object_btn/square.png'; }
      if(k === 'o'){ state.currentTool = 'box';    state.subTool.box    = 'ellipse';icons.box.src    = '/create_parts/object_btn/ellipse.png'; }
      if(k === 'b'){ state.currentTool = 'pen';    state.subTool.pen    = 'brush';  icons.pen.src    = '/create_parts/object_btn/brush.png'; showColorAndHud(); }
      if(k === 'p'){ state.currentTool = 'pen';    state.subTool.pen    = 'pen';    icons.pen.src    = '/create_parts/object_btn/pen.png';   showColorAndHud(); }
      if(k === 'e'){ state.currentTool = 'pen';    state.subTool.pen    = 'eraser'; icons.pen.src    = '/create_parts/object_btn/eraser.png';}
      if(k === 'c'){ // „Ç´„É©„Éº„Éë„Éç„É´„ÅÆ„Éà„Ç∞„É´
        if(colorPanel.classList.contains('hide')){ showColorAndHud(); }
        else { hideColorPanel(); maybeHideHUD(true); }
      }
      if(k === '['){ opacityRange.value = Math.max(0, parseInt(opacityRange.value,10)-5); opacityRange.dispatchEvent(new Event('input')); }
      if(k === ']'){ opacityRange.value = Math.min(100, parseInt(opacityRange.value,10)+5); opacityRange.dispatchEvent(new Event('input')); }
    });

    // ===============================
    // „Éû„Éç„Ç≠„É≥Ôºö„Çπ„É†„Éº„Ç∫„Éî„É≥„ÉÅÔºã‰∫åÊú¨Êåá„Éë„É≥ÔºàÊó¢Â≠òÔºâ
    // ===============================
    (function(){
      const wrap   = document.getElementById('man-zoom');
      const canvas = document.getElementById('canvas');
      let scale=1, targetScale=1, panX=0, targetPanX=0, panY=0, targetPanY=0;
      const MIN=0.5, MAX=4;
      const apply = ()=>{
        wrap.style.setProperty('--man-scale', scale);
        wrap.style.setProperty('--man-x', panX+'px');
        wrap.style.setProperty('--man-y', panY+'px');
      };
      let raf=null;
      function animate(){
        scale += (targetScale-scale)*0.20;
        panX  += (targetPanX -panX )*0.20;
        panY  += (targetPanY -panY )*0.20;
        apply();
        if (Math.abs(targetScale-scale)<0.0005 && Math.abs(targetPanX-panX)<0.1 && Math.abs(targetPanY-panY)<0.1){
          cancelAnimationFrame(raf); raf=null; return;
        }
        raf=requestAnimationFrame(animate);
      }
      const tick=()=>{ if(!raf) raf=requestAnimationFrame(animate); };
      const setScale=s=>{ targetScale=Math.min(MAX,Math.max(MIN,s)); tick(); };
      const addPan=(dx,dy)=>{ targetPanX+=dx; targetPanY+=dy; tick(); };
      canvas.addEventListener('wheel', (e)=>{
        if (e.ctrlKey){ e.preventDefault(); setScale(targetScale * Math.exp(-e.deltaY*0.002)); }
        else{ addPan(-e.deltaX, -e.deltaY); }
      }, {passive:false});
      let gBase=1;
      addEventListener('gesturestart', ()=>{ gBase=targetScale; }, {passive:true});
      addEventListener('gesturechange', (e)=>{ e.preventDefault(); setScale(gBase * e.scale); }, {passive:false});
      let t0=null, base=1;
      const dist=(a,b)=>Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
      const mid =(a,b)=>({x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2});
      canvas.addEventListener('touchstart', e=>{
        if(e.touches.length===2){ const [a,b]=e.touches; t0={d:dist(a,b), c:mid(a,b)}; base=targetScale; }
      }, {passive:true});
      canvas.addEventListener('touchmove', e=>{
        if(e.touches.length===2 && t0){ e.preventDefault(); const [a,b]=e.touches; const d=dist(a,b), c=mid(a,b);
          setScale(base * (d/t0.d)); addPan((c.x - t0.c.x),(c.y - t0.c.y)); }
      }, {passive:false});
      canvas.addEventListener('touchend', ()=>{ t0=null; }, {passive:true});
      let drag=false, mx=0,my=0;
      wrap.addEventListener('mousedown', e=>{ drag=true; mx=e.clientX; my=e.clientY; e.preventDefault(); });
      addEventListener('mousemove', e=>{ if(!drag) return; addPan(e.clientX-mx, e.clientY-my); mx=e.clientX; my=e.clientY; });
      addEventListener('mouseup',   ()=>{ drag=false; });
      let last=0;
      canvas.addEventListener('click', e=>{
        const now=Date.now(); if(now-last<300){ targetScale=1; targetPanX=0; targetPanY=0; tick(); } last=now;
      });
      apply();
    })();
  </script>
</body>
</html>
