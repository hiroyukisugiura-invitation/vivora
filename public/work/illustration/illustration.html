<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Vivora Fashion Illustration 2025</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app" role="application" aria-label="Vivora Fashion Illustration 2025">

    <!-- ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== -->
    <header class="topbar" aria-label="topbar">
      <div class="page-title">Vivora Fashion Illustration 2025</div>

      <div class="top-controls">
        <button class="next-step" id="btn-next">Next Step â–¶â–¶</button>
        <nav class="contents-button" aria-label="contents">
          <img src="/create_parts/contents_button/0_home.png"  alt="Home"        title="Home"        class="cont-btn">
          <img src="/create_parts/contents_button/1_inspiration.png" alt="Insp"  title="Inspiration" class="cont-btn">
          <img src="/create_parts/contents_button/2_mannequin.png"   alt="Manq"  title="Mannequin"   class="cont-btn">
          <img src="/create_parts/contents_button/3_cutting.png"     alt="Cut"   title="Cutting"     class="cont-btn">
          <img src="/create_parts/contents_button/4_pen.png"         alt="Pen"   title="Pen"         class="cont-btn">
          <img src="/create_parts/contents_button/5_color.png"       alt="Color" title="Color"       class="cont-btn">
          <img src="/create_parts/contents_button/6_dic.png"         alt="Dic"   title="Dictionary"  class="cont-btn">
        </nav>
      </div>
    </header>

    <!-- ========== ä½œæ¥­é ˜åŸŸ ========== -->
    <main class="workspace">

      <!-- ãƒœãƒ¼ãƒ‰ï¼šãƒãƒã‚­ãƒ³ + 3æšã®æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ + ã‚°ãƒªãƒƒãƒ‰ -->
      <section id="board" aria-label="canvas-board">
        <!-- ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ–¹çœ¼ç´™ï¼‰ï¼šãƒˆã‚°ãƒ«è¡¨ç¤º -->
        <img id="graph-paper" src="/public/graph_paper.png" alt="Graph Paper">

        <!-- ãƒãƒã‚­ãƒ³ï¼ˆãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ï¼†ãƒ‘ãƒ³ã®ãƒ™ãƒ¼ã‚¹ï¼‰ -->
        <img id="mannequin" src="/public/mannequin/mannequin_woman.png" alt="Mannequin">

        <!-- 3ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆZé †ï¼šä¸‹â†’ä¸Šï¼‰ -->
        <canvas id="layer-1" width="1024" height="640" aria-label="Layer 1"></canvas>
        <canvas id="layer-2" width="1024" height="640" aria-label="Layer 2"></canvas>
        <canvas id="layer-3" width="1024" height="640" aria-label="Layer 3"></canvas>

        <!-- ã‚ºãƒ¼ãƒ HUD -->
        <div id="zoom-hud">100%</div>
      </section>

      <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
      <aside class="sidebar">

        <!-- Upload / Download / Save -->
        <div class="file-tools">
          <button id="btn-upload"  title="Upload (mannequin)">â¬†</button>
          <button id="btn-download" title="Download PNG">â¬‡</button>
          <button id="btn-save"     title="Save Project">ğŸ’¾</button>
        </div>

        <!-- Layer ãƒ‘ãƒãƒ« -->
        <div class="layer-panel" aria-label="layers">
          <!-- å„ãƒœãƒƒã‚¯ã‚¹ï¼šè¡¨ç¤º(V)ãƒ»ãƒ­ãƒƒã‚¯(ğŸ”’)ãƒ»é¸æŠ(â—)ãƒ»ã‚¯ãƒªã‚¢(ğŸ—‘) -->
          <div class="layer-box" data-layer="3">
            <div class="layer-toolbar">
              <button class="vis" title="toggle visibility">ğŸ‘</button>
              <button class="lock" title="lock/unlock">ğŸ”’</button>
              <button class="clr" title="clear layer">ğŸ—‘</button>
            </div>
            <div class="layer-title">Layer 3</div>
            <input type="radio" name="active-layer" checked>
          </div>

          <div class="layer-box" data-layer="2">
            <div class="layer-toolbar">
              <button class="vis" title="toggle visibility">ğŸ‘</button>
              <button class="lock" title="lock/unlock">ğŸ”’</button>
              <button class="clr" title="clear layer">ğŸ—‘</button>
            </div>
            <div class="layer-title">Layer 2</div>
            <input type="radio" name="active-layer">
          </div>

          <div class="layer-box" data-layer="1">
            <div class="layer-toolbar">
              <button class="vis" title="toggle visibility">ğŸ‘</button>
              <button class="lock" title="lock/unlock">ğŸ”’</button>
              <button class="clr" title="clear layer">ğŸ—‘</button>
            </div>
            <div class="layer-title">Layer 1</div>
            <input type="radio" name="active-layer">
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒŠãƒªãƒ¼ -->
        <div class="stationery-tools" aria-label="stationery">
          <button class="tool" data-tool="pencil"   title="é‰›ç­†">âœï¸</button>
          <button class="tool" data-tool="ballpen"  title="ãƒœãƒ¼ãƒ«ãƒšãƒ³">ğŸ–Š</button>
          <button class="tool" data-tool="brush"    title="ç­†ãƒ–ãƒ©ã‚·">ğŸ–Œ</button>
          <button class="tool" data-tool="marker"   title="ãƒãƒ¼ã‚«ãƒ¼">ğŸ–</button>
          <button class="tool" data-tool="anchor"   title="ã‚¢ãƒ³ã‚«ãƒ¼ãƒšãƒ³">ğŸ“</button>
          <button class="tool" data-tool="eraser"   title="æ¶ˆã—ã‚´ãƒ ">ğŸ§½</button>

          <!-- å¤ªã•ï¼šãƒ„ãƒ¼ãƒ«é¸æŠæ™‚ã ã‘è¡¨ç¤º -->
          <label id="size-wrap" class="size-wrap">
            <span>Size</span>
            <input id="size" type="range" min="1" max="60" value="8">
            <span id="size-val">8</span>
          </label>
        </div>

        <!-- Opacity -->
        <div class="opacity-tool" title="Opacity">
          <input id="opacity" type="range" min="5" max="100" value="100">
          <span id="op-val">100%</span>
        </div>

        <!-- Color ãƒ‘ãƒ¬ãƒƒãƒˆ -->
        <div class="color-tool" aria-label="colors">
          <!-- ã‚°ãƒ¬ãƒ¼3 + ã‚«ãƒ©ãƒ¼10 + é»’ ã®12è‰²æ§‹æˆï¼ˆç”»åƒæº–æ‹ ï¼‰ -->
          <button class="color c-gray3"  data-col="#E6E6E6"></button>
          <button class="color c-gray2"  data-col="#BFBFBF"></button>
          <button class="color c-gray1"  data-col="#9E9E9E"></button>

          <button class="color c-ylw"    data-col="#F8D548"></button>
          <button class="color c-org"    data-col="#F6A34D"></button>
          <button class="color c-red"    data-col="#E25B5B"></button>
          <button class="color c-pink"   data-col="#DE6AAE"></button>
          <button class="color c-vio"    data-col="#8E65D8"></button>
          <button class="color c-blu"    data-col="#4E78DA"></button>
          <button class="color c-cyan"   data-col="#42BFD3"></button>
          <button class="color c-grn"    data-col="#58C16C"></button>
          <button class="color c-brwn"   data-col="#A46D4B"></button>
          <button class="color c-black"  data-col="#111111"></button>
        </div>

        <!-- ã‚°ãƒªãƒƒãƒ‰ãƒˆã‚°ãƒ« -->
        <button id="btn-grid" class="grid-btn" title="Toggle Grid (G)">#</button>
      </aside>
    </main>
  </div>

  <!-- =========================
       JavaScriptï¼ˆæç”»ãƒ»æ“ä½œç³»ï¼‰
       ========================= -->
  <script>
  // ============ å‚ç…§å–å¾— ============
  const board = document.getElementById('board');
  const mannequin = document.getElementById('mannequin');
  const grid = document.getElementById('graph-paper');
  const zoomHUD = document.getElementById('zoom-hud');

  const canvases = [
    document.getElementById('layer-1'),
    document.getElementById('layer-2'),
    document.getElementById('layer-3'),
  ];
  const ctxs = canvases.map(c => c.getContext('2d'));

  // ã‚µã‚¤ã‚ºï¼ˆãƒœãƒ¼ãƒ‰ã«å¯¾ã—ã¦ä¸­å¤®ã«åã‚ã‚‹ï¼‰
  function fitCanvases(){
    const w = 1024, h = 640; // ä½œæ¥­é ˜åŸŸï¼ˆç”»åƒæº–æ‹ ï¼šä½™ç™½ã‚’ç¢ºä¿ï¼‰
    canvases.forEach(c => { c.width = w; c.height = h; });
    // ä¸­å¤®é…ç½®ã¯ CSS ã§å®Ÿæ–½ï¼ˆposition:absolute + transform ã§è¿½å¾“ï¼‰
  }
  fitCanvases();

  // ============ çŠ¶æ…‹ ============
  let activeLayer = 2; // 0..2ï¼ˆåˆæœŸï¼šæœ€ä¸Šæ®µ=2ï¼‰
  let tool = null;     // 'pencil' | 'ballpen' | 'brush' | 'marker' | 'anchor' | 'eraser'
  let color = '#111111';
  let size = 8;
  let opacity = 1.0;

  // ã‚ºãƒ¼ãƒ ï¼†ãƒ‘ãƒ³ï¼ˆãƒœãƒ¼ãƒ‰å…¨ä½“ã‚’ transformï¼‰
  let scale = 1.0;
  let tx = 0, ty = 0;

  // ã‚¢ãƒ³ã‚«ãƒ¼ãƒšãƒ³ç”¨
  let anchorPoints = [];
  let anchorActive = false;

  // ============ UI é€£å‹• ============
  // tool
  document.querySelectorAll('.tool').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tool = btn.dataset.tool;
      document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b===btn));
      const showSizer = (tool !== 'anchor'); // ã‚¢ãƒ³ã‚«ãƒ¼ã¯ç·šå¹…ã¯ä»Šã¯ size åæ˜ ã§ã‚‚OK
      document.getElementById('size-wrap').style.display = showSizer ? 'grid' : 'none';
      if(tool==='marker'){ /* markerã®æ—¢å®šé€æ˜åº¦(é‡ã­å¡—ã‚Šæ„Ÿ) */
        document.getElementById('opacity').value = 35; // 35%
        updateOpacity();
      }
      if(tool!=='anchor'){ anchorActive=false; anchorPoints.length=0; }
    });
  });

  // size
  const sizeInput = document.getElementById('size');
  const sizeVal = document.getElementById('size-val');
  function updateSize(){
    size = parseInt(sizeInput.value,10);
    sizeVal.textContent = size;
  }
  sizeInput.addEventListener('input', updateSize);
  updateSize();

  // opacity
  const opInput = document.getElementById('opacity');
  const opVal = document.getElementById('op-val');
  function updateOpacity(){
    opacity = parseInt(opInput.value,10) / 100;
    opVal.textContent = `${Math.round(opacity*100)}%`;
  }
  opInput.addEventListener('input', updateOpacity);
  updateOpacity();

  // colors
  document.querySelectorAll('.color').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      color = btn.dataset.col;
      document.querySelectorAll('.color').forEach(b=>b.classList.toggle('picked', b===btn));
    });
  });
  // æ—¢å®šè‰²ã‚’é¸æŠçŠ¶æ…‹ã«
  document.querySelector('.c-black').classList.add('picked');

  // grid
  const gridBtn = document.getElementById('btn-grid');
  function toggleGrid(){
    grid.classList.toggle('show');
  }
  gridBtn.addEventListener('click', toggleGrid);
  window.addEventListener('keydown', e=>{ if(e.key==='g' || e.key==='G') toggleGrid(); });

  // contents / next stepï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
  document.getElementById('btn-next').addEventListener('click', ()=>alert('Next Step ã¯å¾Œã§æ¥ç¶šã—ã¾ã™'));
  document.querySelectorAll('.cont-btn').forEach(i=>i.addEventListener('click', ()=>alert('Contents ã¯å¾Œã§æ¥ç¶šã—ã¾ã™')));

  // Upload / Download / Save
  document.getElementById('btn-upload').addEventListener('click', ()=>{
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='image/*';
    inp.onchange = e=>{
      const file = e.target.files?.[0]; if(!file) return;
      const url = URL.createObjectURL(file);
      mannequin.src = url; // ãƒãƒã‚­ãƒ³å·®ã—æ›¿ãˆ
    };
    inp.click();
  });

  document.getElementById('btn-download').addEventListener('click', ()=>{
    // åˆæˆç”¨ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹
    const tmp = document.createElement('canvas');
    tmp.width = canvases[0].width;
    tmp.height = canvases[0].height;
    const tctx = tmp.getContext('2d');

    // ãƒãƒã‚­ãƒ³ã‚‚åˆæˆï¼ˆç¾åœ¨ã®transformã¯ç„¡è¦–ã—ã¦åŸå¯¸ã§æ›¸ãå‡ºã—ï¼‰
    // èƒŒæ™¯ã¯ç™½
    tctx.fillStyle='#FFFFFF';
    tctx.fillRect(0,0,tmp.width,tmp.height);

    // ãƒãƒã‚­ãƒ³ã‚’ä½œæ¥­é ˜åŸŸä¸­å¤®ã«ãƒ•ã‚£ãƒƒãƒˆï¼ˆç¾åœ¨ã® CSS ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨åŒç­‰æ¯”ç‡ã§é…ç½®ï¼‰
    // ã“ã“ã§ã¯ã€ãƒãƒã‚­ãƒ³ã®è‡ªç„¶ã‚µã‚¤ã‚ºã§ä¸­å¤®é…ç½®ï¼ˆæœ€é »ã‚±ãƒ¼ã‚¹ï¼‰
    // å¿…è¦ãªã‚‰åº§æ¨™èª¿æ•´ã‚’è¿½åŠ 
    // Layeråˆæˆ
    canvases.forEach(c=>tctx.drawImage(c,0,0));

    const a = document.createElement('a');
    a.download = 'vivora_export.png';
    a.href = tmp.toDataURL('image/png');
    a.click();
  });

  function saveProject(){
    const data = {
      mannequinSrc: mannequin.src,
      grid: grid.classList.contains('show'),
      strokes: canvases.map(c=>c.toDataURL('image/png')),
      color, size, opacity, activeLayer
    };
    localStorage.setItem('vivora_project', JSON.stringify(data));
  }
  document.getElementById('btn-save').addEventListener('click', ()=>{ saveProject(); alert('Saved'); });

  // èµ·å‹•æ™‚å¾©å…ƒ
  (function restore(){
    const raw = localStorage.getItem('vivora_project');
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if(data.mannequinSrc) mannequin.src = data.mannequinSrc;
      if(data.grid) grid.classList.add('show');
      if(Array.isArray(data.strokes)){
        data.strokes.forEach((url,i)=>{
          if(!url) return;
          const img = new Image();
          img.onload = ()=>ctxs[i]?.drawImage(img,0,0);
          img.src = url;
        });
      }
      if(data.color){ color = data.color; }
      if(data.size){ size = data.size; sizeInput.value = size; updateSize(); }
      if(data.opacity){ opacity = data.opacity; opInput.value = Math.round(opacity*100); updateOpacity(); }
      if(typeof data.activeLayer==='number'){
        activeLayer = Math.min(2, Math.max(0, data.activeLayer));
        document.querySelectorAll('.layer-box input[type=radio]')[2-activeLayer].checked = true;
      }
    }catch(e){}
  })();

  // Layer UI
  document.querySelectorAll('.layer-box').forEach(box=>{
    const idx = parseInt(box.dataset.layer,10)-1; // 0..2
    const radio = box.querySelector('input[type=radio]');
    const visBtn = box.querySelector('.vis');
    const lockBtn= box.querySelector('.lock');
    const clrBtn = box.querySelector('.clr');

    radio.addEventListener('change', ()=>{ if(radio.checked) activeLayer = idx; });

    visBtn.addEventListener('click', ()=>{
      const c = canvases[idx];
      c.classList.toggle('hidden');
      visBtn.textContent = c.classList.contains('hidden') ? 'ğŸš«' : 'ğŸ‘';
    });

    lockBtn.addEventListener('click', ()=>{
      canvases[idx].toggleAttribute('data-locked');
      lockBtn.textContent = canvases[idx].hasAttribute('data-locked') ? 'ğŸ”’' : 'ğŸ”“';
    });

    clrBtn.addEventListener('click', ()=>{
      if(confirm('ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){
        ctxs[idx].clearRect(0,0,canvases[idx].width, canvases[idx].height);
      }
    });
  });

  // ============ æç”»ç³»ï¼ˆãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ ============
  const pointer = { down:false, x:0, y:0, prevX:0, prevY:0, id:null };
  let secondTouch = null; // ãƒ”ãƒ³ãƒåˆ¤å®š

  function getActiveCtx(){
    return ctxs[activeLayer];
    }
  function localXY(e){
    const rect = canvases[0].getBoundingClientRect();
    const x = (e.clientX - rect.left - tx) / scale;
    const y = (e.clientY - rect.top  - ty) / scale;
    return {x,y};
  }

  function beginStroke(x,y){
    const ctx = getActiveCtx();
    if(canvases[activeLayer].hasAttribute('data-locked')) return;
    ctx.globalAlpha = (tool==='marker') ? Math.min(0.35, opacity) : opacity;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // ãƒ„ãƒ¼ãƒ«åˆ¥è¨­å®š
    if(tool==='pencil'){
      ctx.strokeStyle = color;
      ctx.lineWidth = Math.max(1, size*0.6);
    }else if(tool==='ballpen'){
      ctx.strokeStyle = color;
      ctx.lineWidth = size;
    }else if(tool==='brush'){
      ctx.strokeStyle = color;
      ctx.lineWidth = size * 1.2;
    }else if(tool==='marker'){
      ctx.strokeStyle = color;
      ctx.lineWidth = size * 1.8;
    }else if(tool==='eraser'){
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = size * 1.6;
    }

    ctx.beginPath();
    ctx.moveTo(x,y);
  }

  function drawTo(x,y,spd=1){
    const ctx = getActiveCtx();
    if(tool==='brush'){
      // é€Ÿåº¦ã«ã‚ˆã‚‹æ“¬ä¼¼ç­†åœ§ï¼šé€Ÿã„ã»ã©ç´°ã
      const lw = Math.max(1, size*1.2 - spd*0.5);
      ctx.lineWidth = lw;
    }
    ctx.lineTo(x,y);
    ctx.stroke();
  }

  function endStroke(){
    const ctx = getActiveCtx();
    // åˆæˆã‚’æˆ»ã™
    if(tool==='eraser'){
      ctx.globalCompositeOperation = 'source-over';
    }
  }

  // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå˜æŒ‡ï¼æç”»ï¼äºŒæŒ‡ï¼ãƒ‘ãƒ³ãƒ»ã‚ºãƒ¼ãƒ ï¼‰
  board.addEventListener('pointerdown', (e)=>{
    board.setPointerCapture(e.pointerId);

    // äºŒæœ¬ç›®ã‚¿ãƒƒãƒï¼Ÿ
    if(pointer.down && secondTouch===null){
      secondTouch = { id:e.pointerId, x:e.clientX, y:e.clientY };
      return;
    }

    pointer.down = true;
    pointer.id = e.pointerId;
    const p = localXY(e);
    pointer.x = pointer.prevX = p.x;
    pointer.y = pointer.prevY = p.y;

    if(tool==='anchor'){
      anchorActive = true;
      anchorPoints.push(p);
      redrawAnchorPreview();
      return;
    }

    if(tool && tool!=='anchor'){
      beginStroke(p.x, p.y);
    }
  });

  board.addEventListener('pointermove', (e)=>{
    if(secondTouch && (e.pointerId===pointer.id || e.pointerId===secondTouch.id)){
      // ãƒ”ãƒ³ãƒï¼ˆè·é›¢ã®å¤‰åŒ–ã§scaleã€ä¸­å¿ƒã§ãƒ‘ãƒ³ï¼‰
      const t1 = (e.pointerId===pointer.id) ? {x:e.clientX, y:e.clientY} : {x:pointer.prevClientX, y:pointer.prevClientY};
      const t2 = (e.pointerId===secondTouch.id) ? {x:e.clientX, y:e.clientY} : {x:secondTouch.x, y:secondTouch.y};

      const prevDist = Math.hypot((pointer.prevClientX??pointer.x)-(secondTouch.x), (pointer.prevClientY??pointer.y)-(secondTouch.y));
      const dist = Math.hypot(t1.x - t2.x, t1.y - t2.y);
      const ratio = (prevDist===0)?1: dist/prevDist;

      scale = Math.min(3, Math.max(0.3, scale * ratio));

      // ä¸­å¿ƒã®ç§»å‹•åˆ†ã‚’ãƒ‘ãƒ³ã«åŠ ç®—
      const prevCx = ((pointer.prevClientX??t1.x) + secondTouch.x)/2;
      const prevCy = ((pointer.prevClientY??t1.y) + secondTouch.y)/2;
      const cx = (t1.x + t2.x)/2;
      const cy = (t1.y + t2.y)/2;
      tx += (cx - prevCx);
      ty += (cy - prevCy);

      applyTransform();
      pointer.prevClientX = t1.x; pointer.prevClientY = t1.y;
      secondTouch.x = t2.x; secondTouch.y = t2.y;
      showZoomHUD();
      return;
    }

    if(!pointer.down || tool==='anchor') return;

    const p = localXY(e);
    const spd = Math.hypot(p.x-pointer.prevX, p.y-pointer.prevY);
    drawTo(p.x, p.y, spd);
    pointer.prevX = p.x; pointer.prevY = p.y;
  });

  board.addEventListener('pointerup', (e)=>{
    if(secondTouch && e.pointerId===secondTouch.id){ secondTouch=null; return; }
    if(e.pointerId!==pointer.id){ return; }

    if(tool && tool!=='anchor'){
      endStroke();
    }
    pointer.down=false; pointer.id=null;
  });

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ³ã‚«ãƒ¼ç¢ºå®š
  board.addEventListener('dblclick', (e)=>{
    if(tool!=='anchor' || anchorPoints.length<2) return;
    finalizeAnchorStroke();
  });

  // ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ ï¼ˆãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ãƒ”ãƒ³ãƒå¯¾å¿œãƒ»ã¾ãŸã¯ ctrl+wheelï¼‰
  board.addEventListener('wheel', (e)=>{
    if(!e.ctrlKey) return; // é€šå¸¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç„¡è¦–
    e.preventDefault();
    const rect = board.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;

    const prevScale = scale;
    scale = Math.min(3, Math.max(0.3, scale * (e.deltaY<0 ? 1.05 : 0.95)));
    // ã‚ºãƒ¼ãƒ ä¸­å¿ƒã‚’ç¶­æŒã™ã‚‹ã‚ˆã†ã«å¹³è¡Œç§»å‹•è£œæ­£
    tx = cx - (cx - tx) * (scale/prevScale);
    ty = cy - (cy - ty) * (scale/prevScale);

    applyTransform();
    showZoomHUD();
  }, {passive:false});

  function applyTransform(){
    const t = `translate(${tx}px, ${ty}px) scale(${scale})`;
    mannequin.style.transform = t;
    canvases.forEach(c=>c.style.transform = t);
    grid.style.transform = t;
  }

  function showZoomHUD(){
    zoomHUD.textContent = `${Math.round(scale*100)}%`;
    zoomHUD.classList.add('show');
    clearTimeout(showZoomHUD._t);
    showZoomHUD._t = setTimeout(()=>zoomHUD.classList.remove('show'), 1000);
  }

  // ============ ã‚¢ãƒ³ã‚«ãƒ¼ãƒšãƒ³ ============
  function redrawAnchorPreview(){
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æœ€ä¸Šæ®µãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è–„ãè¡¨ç¤º
    const ctx = getActiveCtx();
    const c = canvases[activeLayer];
    // ã‚¯ãƒªã‚¢ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    ctx.save();
    ctx.globalAlpha = 1.0;
    ctx.clearRect(0,0,c.width,c.height);
    ctx.restore();

    // æ—¢å­˜å†…å®¹ã¯ä¿æŒã—ãŸã„ã®ã§ã€åˆ¥ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æãã®ã¯é›£ã—ã„
    // -> ç°¡æ˜“çš„ã«ã‚¬ã‚¤ãƒ‰ç‚¹ã®ã¿ã‚’æç”»
    const g = ctx;
    g.save();
    g.strokeStyle = '#4E78DA';
    g.fillStyle = '#4E78DA';
    g.lineWidth = 1;
    for(let i=0;i<anchorPoints.length;i++){
      const p = anchorPoints[i];
      g.beginPath(); g.arc(p.x, p.y, 3, 0, Math.PI*2); g.fill();
      if(i>0){ g.beginPath(); g.moveTo(anchorPoints[i-1].x, anchorPoints[i-1].y); g.lineTo(p.x,p.y); g.stroke(); }
    }
    g.restore();
  }

  function finalizeAnchorStroke(){
    const ctx = getActiveCtx();
    if(canvases[activeLayer].hasAttribute('data-locked')) return;
    ctx.save();
    ctx.globalAlpha = opacity;
    ctx.strokeStyle = color;
    ctx.lineWidth  = size;
    ctx.lineJoin = 'round';
    ctx.lineCap  = 'round';
    ctx.beginPath();
    ctx.moveTo(anchorPoints[0].x, anchorPoints[0].y);
    for(let i=1;i<anchorPoints.length;i++){
      ctx.lineTo(anchorPoints[i].x, anchorPoints[i].y);
    }
    ctx.stroke();
    ctx.restore();
    anchorPoints.length=0; anchorActive=false;
  }

  // ============ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆæœŸåŒ– ============
  // åˆå›ã¯ã‚°ãƒªãƒƒãƒ‰éè¡¨ç¤º
  grid.classList.remove('show');

  // è‡ªå‹•ä¿å­˜ï¼ˆ30ç§’ã”ã¨ï¼‰
  setInterval(saveProject, 30000);
  </script>
</body>
</html>
