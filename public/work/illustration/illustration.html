<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vivora Fashion Illustration 2025</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500&display=swap" rel="stylesheet">

  <!-- Page CSS (既存) -->
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* 追加: ドロー用キャンバスと簡易レイヤUIの最低限スタイル */
    .draw-layer{position:absolute; inset:0; pointer-events:none;}
    .selected-layer{outline:2px solid #444; outline-offset:-2px;}
    .panel .row{display:flex; align-items:center; gap:8px; margin-bottom:8px;}
    .mini{font-size:12px; color:#777;}
    .tool{
      width:32px;height:32px;border-radius:6px;background:#fff;cursor:pointer;
      border:1px solid var(--border-color);
      display:flex;align-items:center;justify-content:center;
    }
    .tool.active{outline:2px solid #222; outline-offset:2px}
    .sl{width:100%}
    .layer-list{list-style:none; max-height:180px; overflow:auto; margin:6px 0 0;
      border:1px solid var(--border-color); border-radius:8px; background:#fff}
    .layer-list li{padding:8px 10px; border-bottom:1px solid #f0e9e5; cursor:pointer}
    .layer-list li.active{background:#ece7e3}
    .layers-row{display:flex; gap:6px; margin-top:8px}
    .ly-btn{
      height:28px; padding:0 10px; border:1px solid var(--border-color);
      background:#fff; border-radius:6px; cursor:pointer
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- ============ Main ============ -->
    <main class="main-workspace">
      <header class="main-header">
        <h1 class="title">Vivora Fashion Illustration 2025</h1>
        <div class="gender-selector">
          <button class="gender-button active" data-gender="woman">Woman</button>
          <button class="gender-button" data-gender="man">Man</button>
          <button class="gender-button" data-gender="kids">Kids</button>
        </div>
      </header>

      <!-- Toolbars -->
      <div class="toolbar-area">
        <!-- Actions -->
        <div class="action-toolbar">
          <button class="icon-button" id="btn-undo" aria-label="Undo"><img src="../../create_parts/create_button/retreat.png" alt="Undo"></button>
          <button class="icon-button" id="btn-redo" aria-label="Redo"><img src="../../create_parts/create_button/forward.png" alt="Redo"></button>
          <button class="icon-button" id="btn-reset" aria-label="Reset"><img src="../../create_parts/create_button/reset.png" alt="Reset"></button>
          <button class="icon-button" id="btn-download" aria-label="Download"><img src="../../create_parts/create_button/download.png" alt="Download"></button>
          <button class="icon-button" id="btn-upload" aria-label="Upload"><img src="../../create_parts/create_button/upload.png" alt="Upload"></button>
          <button class="icon-button" id="btn-save" aria-label="Save"><img src="../../create_parts/create_button/save.png" alt="Save"></button>
          <button class="icon-button" id="grid-toggle" aria-label="Grid"><img src="../../create_parts/create_button/graph_paper.png" alt="Grid"></button>
        </div>

        <!-- Contents (先頭に Home 追加) -->
        <div class="content-toolbar">
          <button class="icon-button" title="Home">
            <img src="../../create_parts/contents_button/0_home.png" alt="Home" />
          </button>
          <button class="icon-button" title="Fashion Illustration">
            <img src="../../create_parts/contents_button/1_fashion-illustrations.png" alt="Fashion Illustration">
          </button>
          <button class="icon-button" title="Fabric Matching">
            <img src="../../create_parts/contents_button/2_fabric-matching.png" alt="Fabric Matching">
          </button>
          <button class="icon-button" title="Clothing Design">
            <img src="../../create_parts/contents_button/3_clothing-design.png" alt="Clothing Design">
          </button>
          <button class="icon-button" title="Pattern Creation">
            <img src="../../create_parts/contents_button/4_pattern-creation.png" alt="Pattern Creation">
          </button>
          <button class="icon-button" title="Grading">
            <img src="../../create_parts/contents_button/5_grading.png" alt="Grading">
          </button>
          <button class="icon-button" title="Print Layout & Cut">
            <img src="../../create_parts/contents_button/6_print-layout-cut.png" alt="Print Layout">
          </button>
          <button class="icon-button" title="Digital Kids Dressing">
            <img src="../../create_parts/contents_button/digital-dressing-kids-mode.png" alt="Digital Kids Dressing">
          </button>
        </div>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrapper" class="canvas-wrapper">
        <img id="mannequin" class="mannequin-base" src="../../mannequin/mannequin_woman.png" alt="Mannequin">
        <!-- ドロー用キャンバス（JSがサイズ調整） -->
        <canvas id="draw-layer" class="draw-layer"></canvas>
      </div>
    </main>

    <!-- ============ Sidebar ============ -->
    <aside class="sidebar-controls">
      <div class="next-step-panel">
        <button class="next-step-button">Next Step ▶▶</button>
      </div>

      <!-- Pose -->
      <div id="pose-selector" class="panel pose-selector">
        <button class="arrow left-arrow" aria-label="Prev Pose">‹</button>
        <div class="pose-thumbnails">
          <img class="pose-thumb selected" src="../../mannequin/pose1.png"
               data-pose-src="../../mannequin/mannequin_woman.png" alt="Pose 1">
          <img class="pose-thumb" src="../../mannequin/pose2.png"
               data-pose-src="../../mannequin/mannequin_woman_pose2.png" alt="Pose 2">
          <img class="pose-thumb" src="../../mannequin/pose3.png"
               data-pose-src="../../mannequin/mannequin_woman_pose3.png" alt="Pose 3">
          <img class="pose-thumb" src="../../mannequin/pose4.png"
               data-pose-src="../../mannequin/mannequin_woman_pose4.png" alt="Pose 4">
        </div>
        <button class="arrow right-arrow" aria-label="Next Pose">›</button>
      </div>

      <!-- Stationery -->
      <div id="stationery-panel" class="panel stationery-panel">
        <h2 class="panel-title">Stationery</h2>
        <div id="stationery-grid" class="stationery-grid">
          <div class="tool-button" data-tool="select"><img src="../../create_parts/design_button/select.png" alt="Select"></div>
          <div class="tool-button" data-tool="direct_select"><img src="../../create_parts/design_button/direct_select.png" alt="Direct Select"></div>
          <div class="tool-button" data-tool="text"><img src="../../create_parts/design_button/sentence.png" alt="Text"></div>
          <div class="tool-button" data-tool="fill"><img src="../../create_parts/design_button/fill.png" alt="Fill"></div>
          <div class="tool-button" data-tool="pen"><img src="../../create_parts/design_button/pen.png" alt="Pen"></div>
          <div class="tool-button" data-tool="brush"><img src="../../create_parts/design_button/brush.png" alt="Brush"></div>
          <div class="tool-button" data-tool="eraser"><img src="../../create_parts/design_button/eraser.png" alt="Eraser"></div>
          <div class="tool-button" data-tool="rotate"><img src="../../create_parts/design_button/rotate.png" alt="Rotate"></div>
          <div class="tool-button" data-tool="percent"><img src="../../create_parts/design_button/percent.png" alt="Percent"></div>
          <div class="tool-button" data-tool="photo"><img src="../../create_parts/design_button/photo.png" alt="Photo"></div>
          <div class="tool-button" data-tool="add"><img src="../../create_parts/design_button/add.png" alt="Add"></div>
          <div class="tool-button" data-tool="shapes"><img src="../../create_parts/design_button/shapes.png" alt="Shapes"></div>
        </div>
      </div>

      <!-- Draw & Layers（最小構成） -->
      <div class="panel">
        <h2 class="panel-title">Draw & Layers</h2>
        <div class="row">
          <button class="tool t-pencil" title="Brush" aria-label="Brush">✎</button>
          <button class="tool t-eraser" title="Eraser" aria-label="Eraser">⌫</button>
          <input id="brush-size" class="sl" type="range" min="1" max="40" value="6" />
        </div>
        <div class="row mini">
          <label><input id="symmetry" type="checkbox" /> Symmetry</label>
        </div>
        <div class="row mini">
          <label>Mannequin Opacity</label>
          <input id="mannequin-opacity" class="sl" type="range" min="0" max="100" value="100">
        </div>
        <ul id="layer-list" class="layer-list"></ul>
        <div class="layers-row">
          <button id="ly-up" class="ly-btn">Front</button>
          <button id="ly-down" class="ly-btn">Back</button>
          <button id="ly-del" class="ly-btn">Delete</button>
        </div>
      </div>

      <!-- Color -->
      <div id="color-panel" class="panel color-panel">
        <h2 class="panel-title">Color <button class="custom-button">Custom...</button></h2>
        <div id="color-grid" class="color-grid">
          <div class="color-box selected" style="background-color: #ffffff;" data-color="#ffffff"></div>
          <div class="color-box" style="background-color: #cccccc;" data-color="#cccccc"></div>
          <div class="color-box" style="background-color: #ffff00;" data-color="#ffff00"></div>
          <div class="color-box" style="background-color: #ff9900;" data-color="#ff9900"></div>
          <div class="color-box" style="background-color: #f4a2a2;" data-color="#f4a2a2"></div>
          <div class="color-box" style="background-color: #ff0000;" data-color="#ff0000"></div>
          <div class="color-box" style="background-color: #009900;" data-color="#009900"></div>
          <div class="color-box" style="background-color: #006600;" data-color="#006600"></div>
          <div class="color-box" style="background-color: #3399ff;" data-color="#3399ff"></div>
          <div class="color-box" style="background-color: #0000ff;" data-color="#0000ff"></div>
          <div class="color-box" style="background-color: #990099;" data-color="#990099"></div>
          <div class="color-box" style="background-color: #000000;" data-color="#000000"></div>
          <button class="color-box add-color-button">+</button>
          <button class="color-box add-color-button">+</button>
          <button class="color-box add-color-button">+</button>
          <button class="color-box eyedropper-button" title="Eyedropper">
            <img src="../../color/pc_color/eyedropper.png" alt="Eyedropper">
          </button>
        </div>
      </div>
    </aside>
  </div>

  <!-- ===== Script (Undo/Redo・Draw・Layers 統合) ===== -->
  <script>
/* ---------- State (Undo/Redo) ---------- */
const State = (() => {
  const undoStack = [], redoStack = [];
  const MAX = 50;
  const snapshot = () => ({
    canvasHTML: document.getElementById('canvas-wrapper').innerHTML,
    gender: document.querySelector('.gender-button.active')?.dataset.gender || 'woman',
    grid: document.getElementById('canvas-wrapper').classList.contains('grid-active')
  });
  const restore = (snap) => {
    const wrap = document.getElementById('canvas-wrapper');
    wrap.innerHTML = snap.canvasHTML;
    // 再取得（描画レイヤ等）
    rebindCanvasRefs();
    wrap.classList.toggle('grid-active', snap.grid);
    document.querySelectorAll('.gender-button').forEach(b=>{
      b.classList.toggle('active', b.dataset.gender===snap.gender);
    });
    // 再初期化
    fitDrawCanvas();
    Layer.initSelectable();
    refreshLayerList();
  };
  const push = () => { undoStack.push(snapshot()); if (undoStack.length>MAX) undoStack.shift(); redoStack.length=0; };
  const undo = () => { if(!undoStack.length) return; const cur=snapshot(), prev=undoStack.pop(); redoStack.push(cur); restore(prev); };
  const redo = () => { if(!redoStack.length) return; const cur=snapshot(), next=redoStack.pop(); undoStack.push(cur); restore(next); };
  return { push, undo, redo };
})();

/* ---------- Canvas & Draw ---------- */
const ART = document.getElementById('canvas-wrapper');
let mannequinEl = document.getElementById('mannequin');
let drawCanvas = document.getElementById('draw-layer');
let dctx = drawCanvas.getContext('2d');

function rebindCanvasRefs(){
  mannequinEl = document.getElementById('mannequin');
  drawCanvas  = document.getElementById('draw-layer');
  dctx = drawCanvas.getContext('2d');
}

function fitDrawCanvas(){
  const r = ART.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  drawCanvas.style.width  = r.width  + 'px';
  drawCanvas.style.height = r.height + 'px';
  drawCanvas.width  = Math.max(1, Math.round(r.width*dpr));
  drawCanvas.height = Math.max(1, Math.round(r.height*dpr));
  dctx.setTransform(dpr,0,0,dpr,0,0);
  dctx.lineCap='round'; dctx.lineJoin='round';
}
fitDrawCanvas();
window.addEventListener('resize', fitDrawCanvas);

// Screen → Canvas座標
function screenToCanvas(x,y){ const r=ART.getBoundingClientRect(); return [x-r.left, y-r.top]; }

let drawMode=null;         // 'brush' | 'erase' | null
let brushSize=6; let symmetryOn=false;

function setDrawMode(m){
  drawMode = m;
  document.querySelectorAll('.t-pencil,.t-eraser').forEach(b=>b.classList.remove('active'));
  if(m==='brush') document.querySelector('.t-pencil')?.classList.add('active');
  if(m==='erase') document.querySelector('.t-eraser')?.classList.add('active');
  drawCanvas.style.pointerEvents = drawMode ? 'auto' : 'none';
}
function getActiveColor(){
  const sel = document.querySelector('.color-box.selected');
  return sel?.dataset.color || '#111';
}

let drawing=false,lx=0,ly=0;
drawCanvas.addEventListener('pointerdown',e=>{
  if(!drawMode) return;
  drawing=true; drawCanvas.setPointerCapture(e.pointerId);
  [lx,ly]=screenToCanvas(e.clientX,e.clientY);
  dctx.beginPath(); dctx.moveTo(lx,ly);
});
drawCanvas.addEventListener('pointermove',e=>{
  if(!drawing||!drawMode) return;
  const [x,y]=screenToCanvas(e.clientX,e.clientY);
  dctx.lineWidth=brushSize;
  if(drawMode==='brush'){ dctx.globalCompositeOperation='source-over'; dctx.strokeStyle=getActiveColor(); }
  else{ dctx.globalCompositeOperation='destination-out'; dctx.strokeStyle='rgba(0,0,0,1)'; }
  dctx.lineTo(x,y); dctx.stroke();

  if(symmetryOn){
    const w = drawCanvas.getBoundingClientRect().width;
    const sx = w - lx, tx = w - x;
    dctx.beginPath(); dctx.moveTo(sx,ly); dctx.lineTo(tx,y); dctx.stroke();
  }
  lx=x; ly=y;
});
drawCanvas.addEventListener('pointerup',()=>{ if(!drawing) return; drawing=false; State.push(); });

/* ---------- Layer: overlays ---------- */
const Layer = (() => {
  let selectedEl=null;
  const select = (el)=>{ if(selectedEl) selectedEl.classList.remove('selected-layer'); selectedEl=el; if(el) el.classList.add('selected-layer'); };
  const initSelectable = ()=>{
    ART.querySelectorAll('.overlay-item').forEach(el=>{
      el.addEventListener('click',e=>{ e.stopPropagation(); select(el); refreshLayerList(); });
    });
  };
  ART.addEventListener('click',()=>{ select(null); refreshLayerList(); });

  // 色適用（画像はtintを重ねる）
  const applyColor = (hex)=>{
    if(!selectedEl) return;
    if(selectedEl.tagName.toLowerCase()==='svg'){
      selectedEl.querySelectorAll('.paintable').forEach(p=>p.setAttribute('fill',hex));
      return;
    }
    if(!selectedEl.querySelector(':scope>.tint')){
      const t=document.createElement('div'); t.className='tint';
      Object.assign(t.style,{position:'absolute',inset:'0',background:hex+'80',pointerEvents:'none'});
      selectedEl.style.position='absolute'; selectedEl.appendChild(t);
    }else{
      selectedEl.querySelector(':scope>.tint').style.background=hex+'80';
    }
  };

  // 画像追加
  const addPart = (src)=>{
    const holder=document.createElement('div');
    holder.className='overlay-item';
    Object.assign(holder.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-50%)',width:'45%',aspectRatio:'3/4',pointerEvents:'auto'});
    const img=document.createElement('img');
    Object.assign(img.style,{width:'100%',height:'100%',objectFit:'contain'}); img.src=src; img.alt='part';
    holder.appendChild(img);

    // drag
    let dragging=false,sx=0,sy=0,bx=0,by=0;
    holder.addEventListener('pointerdown',e=>{
      dragging=true; holder.setPointerCapture(e.pointerId);
      sx=e.clientX; sy=e.clientY;
      const rect=holder.getBoundingClientRect(), cRect=ART.getBoundingClientRect();
      bx=rect.left-cRect.left; by=rect.top-cRect.top; select(holder); refreshLayerList();
    });
    holder.addEventListener('pointermove',e=>{
      if(!dragging) return;
      const cRect=ART.getBoundingClientRect();
      const nx=bx+(e.clientX-sx), ny=by+(e.clientY-sy);
      holder.style.left=(nx+holder.offsetWidth/2)/cRect.width*100+'%';
      holder.style.top =(ny+holder.offsetHeight/2)/cRect.height*100+'%';
      holder.style.transform='translate(-50%,-50%)';
    });
    holder.addEventListener('pointerup',()=>{ dragging=false; State.push(); });

    ART.appendChild(holder); select(holder); refreshLayerList();
  };

  return { initSelectable, applyColor, addPart };
})();

/* ---------- Layers UI ---------- */
function refreshLayerList(){
  const list=document.getElementById('layer-list'); if(!list) return;
  list.innerHTML='';
  const items=[];
  items.push({el:mannequinEl,name:'Mannequin'});
  items.push({el:drawCanvas, name:'Draw'});
  ART.querySelectorAll('.overlay-item').forEach((el,i)=>items.push({el,name:`Image ${i+1}`}));
  items.forEach(it=>{
    const li=document.createElement('li'); li.textContent=it.name;
    if(it.el.classList?.contains('selected-layer')) li.classList.add('active');
    li.addEventListener('click',()=>{ ART.querySelectorAll('.overlay-item').forEach(n=>n.classList.remove('selected-layer')); it.el.classList?.add('selected-layer'); refreshLayerList(); });
    list.appendChild(li);
  });
}
const mo=new MutationObserver(refreshLayerList); mo.observe(ART,{childList:true});
refreshLayerList();

document.getElementById('ly-up')?.addEventListener('click',()=>{
  const sel=ART.querySelector('.overlay-item.selected-layer'); if(!sel) return;
  if(sel.nextElementSibling) ART.insertBefore(sel.nextElementSibling, sel);
  refreshLayerList(); State.push();
});
document.getElementById('ly-down')?.addEventListener('click',()=>{
  const sel=ART.querySelector('.overlay-item.selected-layer'); if(!sel) return;
  if(sel.previousElementSibling) ART.insertBefore(sel, sel.previousElementSibling);
  refreshLayerList(); State.push();
});
document.getElementById('ly-del')?.addEventListener('click',()=>{
  const sel=ART.querySelector('.overlay-item.selected-layer'); if(!sel) return; sel.remove();
  refreshLayerList(); State.push();
});

/* ---------- Wiring (Top UI) ---------- */
State.push();

document.getElementById('btn-undo')?.addEventListener('click', State.undo);
document.getElementById('btn-redo')?.addEventListener('click', State.redo);

document.getElementById('btn-reset')?.addEventListener('click', ()=>{
  ART.innerHTML='';
  const img=document.createElement('img');
  img.id='mannequin'; img.className='mannequin-base';
  img.src='../../mannequin/mannequin_woman.png'; img.alt='Mannequin';
  const cvs=document.createElement('canvas'); cvs.id='draw-layer'; cvs.className='draw-layer';
  ART.appendChild(img); ART.appendChild(cvs);
  rebindCanvasRefs(); fitDrawCanvas(); Layer.initSelectable(); refreshLayerList(); State.push();
});

document.getElementById('btn-download')?.addEventListener('click',()=>{
  const blob=new Blob([ART.innerHTML],{type:'text/html'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vivora-illustration.htmlfrag'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('btn-upload')?.addEventListener('click',()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*,.svg';
  inp.onchange=e=>{ const f=e.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); Layer.addPart(url); State.push(); };
  inp.click();
});
document.getElementById('btn-save')?.addEventListener('click',()=>{
  localStorage.setItem('vivora-illustration-snap', JSON.stringify(ART.innerHTML));
  alert('Saved locally.');
});
document.getElementById('grid-toggle')?.addEventListener('click',()=>{
  ART.classList.toggle('grid-active'); State.push();
});

/* Gender */
document.querySelectorAll('.gender-button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.gender-button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const map={
      woman:'../../mannequin/mannequin_woman.png',
      man:'../../mannequin/mannequin_man.png',
      kids:'../../mannequin/mannequin_kids.png'
    };
    mannequinEl.src=map[btn.dataset.gender]||mannequinEl.src; State.push();
  });
});

/* Pose */
document.querySelectorAll('.pose-thumb').forEach(ph=>{
  ph.addEventListener('click',()=>{
    document.querySelectorAll('.pose-thumb').forEach(p=>p.classList.remove('selected'));
    ph.classList.add('selected');
    mannequinEl.src = ph.dataset.poseSrc || mannequinEl.src; State.push();
  });
});

/* Stationery→画像追加（data-part-src があれば） */
document.querySelectorAll('.tool-button').forEach(tb=>{
  tb.addEventListener('click',()=>{
    const src=tb.dataset.partSrc;
    if(src){ Layer.addPart(src); State.push(); }
  });
});

/* Color */
document.querySelectorAll('.color-box[data-color]').forEach(cb=>{
  cb.addEventListener('click',()=>{
    document.querySelectorAll('.color-box').forEach(x=>x.classList.remove('selected'));
    cb.classList.add('selected');
    // Layerへの塗り（選択要素がある場合）
    Layer.applyColor(cb.dataset.color);
    State.push();
  });
});

/* Draw UI */
document.querySelector('.t-pencil')?.addEventListener('click',()=> setDrawMode(drawMode==='brush'?null:'brush'));
document.querySelector('.t-eraser')?.addEventListener('click',()=> setDrawMode(drawMode==='erase'?null:'erase'));
document.getElementById('brush-size')?.addEventListener('input',e=> brushSize=+e.target.value);
document.getElementById('symmetry')?.addEventListener('change',e=> symmetryOn = e.target.checked);
document.getElementById('mannequin-opacity')?.addEventListener('input',e=> mannequinEl.style.opacity=(+e.target.value/100)+'');
/* 初回 */
Layer.initSelectable();
  </script>
</body>
</html>
